@page "/polist"
@using Entities.Models
@using Entities.Models.POModule
@using OceanVMSClient.Components
@using Shared.DTO.POModule
@using MudBlazor.Components
@using OceanVMSClient.SharedComp.Components
@inject IDialogService DialogService

<style>
    /* Prevent wrapping for cells that should stay on one line */
    .no-wrap {
        white-space: nowrap;
    }
</style>

<MudBreadcrumbs Items="_items" Separator="/" Class="mb-0" />
<PageHeader Title="Purchase Orders" Class="mb-0" />

<MudPaper Class="pa-2 po-paper">
    <!-- Top summary -->
    <!-- Filters -->
    <MudPaper Elevation="1" Class="pa-2 po-section">
        <MudGrid GutterSize="2" AlignItems="AlignItems.Center">
            <MudItem xs="12" md="12">
                <MudGrid GutterSize="1" Spacing="1">
                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="string"
                                      Typo="Typo.caption"
                                      Label="SAP PO No"
                                      Placeholder="SAP PO No"
                                      OnDebounceIntervalElapsed="@( (string s) => { sapPONo = s; return OnSearch(); } )"
                                      DebounceInterval="500"
                                      Dense="true"
                                      Class="filter-control" />
                    </MudItem>

                    <MudItem xs="12" sm="2" md="2">
                       
                        <MudTextField T="string"
                                      Typo="Typo.caption"
                                      Label="Vendor"
                                      Placeholder="Vendor Name"
                                      Value="@vendorName"
                                      Dense="true"
                                      DebounceInterval="500"
                                      OnDebounceIntervalElapsed="@((string s) => { vendorName = s; return OnSearch(); })"
                                       Class="filter-control" />

                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">

                        <MudTextField T="string"
                                      Typo="Typo.caption"
                                      Label="Project Code"
                                      Placeholder="Project Code"
                                      Value="@projectCode"
                                      Dense="true"
                                      DebounceInterval="500"
                                      OnDebounceIntervalElapsed="@((string s) => { projectCode = s; return OnSearch(); })"
                                      Class="filter-control" />

                    </MudItem>

                    <MudItem xs="12" sm="1" md="1">
                        <MudTextField T="decimal?"
                                      Typo="Typo.caption"
                                      Label="Min Total"
                                      InputType="InputType.Number"
                                      ValueChanged="@( (decimal? v) => { minTotalValue = v; return OnSearch(); } )"
                                      Placeholder="Min"
                                      Clearable="true"
                                      Dense="true"
                                      Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="1" md="1">
                        <MudTextField T="decimal?"
                                      Typo="Typo.caption"
                                      Label="Max Total"
                                      InputType="InputType.Number"
                                      ValueChanged="@( (decimal? v) => { maxTotalValue = v; return OnSearch(); } )"
                                      Placeholder="Max"
                                      Clearable="true"
                                      Dense="true"
                                      Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudSelect T="string"
                                   Label="Invoice Status"
                                   Placeholder=""
                                   Typo="Typo.caption"
                                   Value="selectedInvoiceStatus"
                                   ValueChanged="OnInvoiceStatusChanged"
                                   Dense="true"
                                   Class="filter-control">
                            @foreach (var status in invoiceStatuses)
                            {
                                <MudSelectItem Value="@status">@status</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudDateRangePicker @ref="_dateRangePicker"
                                            DateRangeChanged="OnDateRangeSearch"
                                            DateFormat="dd-MMM-yy"
                                            TitleDateFormat="MMMM dd"
                                            Margin="Margin.Dense"
                                            Variant="Variant.Text"
                                            Dense="true"
                                            Label="PO Date"
                                            Clearable="true"
                                            AutoClose="true"
                                            Class="filter-control">
                            <PickerActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearDateRange">Clear</MudButton>
                            </PickerActions>
                        </MudDateRangePicker>
                    </MudItem>

                   
                </MudGrid>
            </MudItem>


        </MudGrid>
    </MudPaper>

    <!-- Table -->
    <MudTable T="PurchaseOrderDto"
              ServerData="GetServerData"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              RightAlignSmall="true"
              Dense="true"
              @ref="_table"
              RowsPerPage="15"
              Virtualize=" true"
              Class="po-table mt-3"
              FixedHeader="true"
              FixedFooter="true">
        <HeaderContent>
            @* <MudTh Class="col-type">Type</MudTh> *@
            <MudTh Class="col-pono">PONo</MudTh>
            <MudTh>PO.Date</MudTh>
            <MudTh>Supplier</MudTh>
            <MudTh>Project</MudTh>
            <MudTh Align="Align.Right">Item.Value</MudTh>
            <MudTh Align="Align.Right">Tax.Value</MudTh>
            <MudTh Align="Align.Right">Total.Value</MudTh>
            <MudTh>Inv.Status</MudTh>
            <MudTh></MudTh>
        </HeaderContent>

        <RowTemplate>
            @* <MudTd>
                <MudText Typo="Typo.subtitle2" Class="cell-text">@context.PoTypeName</MudText>
            </MudTd> *@
            <MudTd>
                <MudLink Typo="Typo.subtitle2" Class="cell-link" Href="@($"ViewPurchaseOrder/{context.Id}")" Color="Color.Primary" Underline="Underline.Hover">
                    @context.SAPPONumber
                </MudLink>
            </MudTd>
            <MudTd DataLabel="PODate" Class="no-wrap">
                <MudText Typo="Typo.subtitle2">
                    @FormatDate(context.SAPPODate)
                </MudText>
            </MudTd>
            <MudTd DataLabel="Vendor" Class="no-wrap">
                <MudText Typo="Typo.subtitle2">
                    @context.VendorName
                </MudText>
            </MudTd>
            <MudTd DataLabel="ProjectID">
                <MudText Typo="Typo.subtitle2">
                    @context.ProjectCode
                </MudText>
            </MudTd>
            <MudTd Align="Align.Right">
                <MudText Typo="Typo.subtitle2">
                    <CurrencyText Amount="@context.ItemValue" />
                </MudText>
            </MudTd>
            <MudTd Align="Align.Right">
                <MudText Typo="Typo.subtitle2">
                    <CurrencyText Amount="@context.GSTTotal" />
                </MudText>
            </MudTd>
            <MudTd Align="Align.Right" Class="total-col">
                <MudText Typo="Typo.subtitle2">
                    <CurrencyText Amount="@context.TotalValue" />
                </MudText>
            </MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetInvoiceChipColor(context.InvoiceStatus)" Variant="Variant.Filled">@context.InvoiceStatus</MudChip>
            </MudTd>
            <MudTd>
                <MudIconButton OnClick="@(() => ToggleRow(context.Id))"
                               Icon="@(IsRowExpanded(context.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Outlined.ArrowDropDown)"
                               Variant="Variant.Text"
                               Color="Color.Info"
                               Size="Size.Large" />
            </MudTd>
        </RowTemplate>

        <ChildRowContent Context="row">
            @if (IsRowExpanded(row.Id))
            {
                <MudTd ColSpan="9" Class="child-row-td">
                    <MudPaper Class="pa-3 child-row-paper" Elevation="1">
                        <MudGrid GutterSize="2" AlignItems="AlignItems.Center">
                            <MudItem xs="4" sm="4">
                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">PO Details</MudText>
                                <MudDivider Class="my-1" />

                                <MudItem>
                                    <MudText Typo="Typo.subtitle2" Color="Color.Default">
                                        Project
                                    </MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Info">
                                        @row.ProjectName
                                    </MudText>

                                </MudItem>
                                <MudDivider Class="my-1" />
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2" Color="Color.Default">
                                        Supplier
                                    </MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Info">
                                        @row.VendorName
                                    </MudText>
                                </MudItem>
                            </MudItem>

                            <MudItem xs="6" sm="6">
                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">Invoice Details</MudText>
                                <MudDivider Class="my-1" />
                                <MudGrid GutterSize="1">
                                    <MudItem xs="6" sm="6">

                                        <MudItem>

                                            <MudText Typo="Typo.subtitle2" Color="Color.Default">
                                                Invoice Count
                                            </MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Info">
                                                @row.PreviousInvoiceCount
                                            </MudText>
                                        </MudItem>
                                        <MudDivider Class="my-1" />
                                        <MudItem>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Default">
                                                Previous Invoices
                                            </MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Info">
                                                <CurrencyText Amount="@row.PreviousInvoiceValue" />
                                            </MudText>
                                        </MudItem>
                                    </MudItem>

                                    <MudItem xs="6" sm="6">
                                        <MudItem>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Default">
                                                Invoice Balance
                                            </MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Info">
                                                <CurrencyText Amount="@row.InvoiceBalanceValue" />
                                            </MudText>
                                        </MudItem>
                                        <MudDivider Class="my-1" />
                                    </MudItem>
                                </MudGrid>

                            </MudItem>

                            <MudItem xs="2" sm="2">
                                <MudItem Class="d-flex justify-content-end">
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Add"
                                               OnClick="@(() => newInvoice(row.VendorId, row.Id))"
                                               Disabled="@(!GetCanCreateInvoiceForRow(row) || isDetailsLoading || isActionInProgress)"
                                               Style="width: 200px;">
                                        Create Invoice
                                    </MudButton>
                                </MudItem>
                                <MudDivider Class="my-1" />
                                <MudItem Class="d-flex justify-content-end">
                                    <MudButton Color="Color.Secondary" Variant="Variant.Outlined" Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Visibility"
                                               Style="width: 200px;"
                                               OnClick="@(() => ShowInvoices(row.Id))">
                                        View Invoices
                                    </MudButton>
                                </MudItem>
                            </MudItem>

                        </MudGrid>
                    </MudPaper>
                </MudTd>
            }
        </ChildRowContent>

        <PagerContent>
            <MudTablePager PageSizeOptions="@_pageSizeOption" RowsPerPageString="POs Per Page" />
        </PagerContent>
    </MudTable>
    <MudDivider Class="mt-2" />
    <MudItem xs="12" Class="d-flex justify-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportVisibleToCsv">
            Export CSV
        </MudButton>
    </MudItem>
</MudPaper>



@code {
    private List<BreadcrumbItem> _items = new()
    {
        new BreadcrumbItem("Home", href: "/", disabled: false),
        new BreadcrumbItem("Purchase Orders", href: "/POList", disabled: false),
    };

    // Add these fields to fix CS0103 errors
    private bool CanCreateInvoice { get; set; } = true;
    private bool isDetailsLoading { get; set; } = false;
    private bool isActionInProgress { get; set; } = false;

    // Add this method to fix CS0103

}