@page "/polist"
@using Entities.Models
@using Entities.Models.POModule
@using OceanVMSClient.Components
@using Shared.DTO.POModule
@using MudBlazor.Components
@using OceanVMSClient.SharedComp.Components
@inject IDialogService DialogService

<PageNavigation Items="_items" />

<MudPaper Elevation="1" Class="po-appbar">
    <MudGrid Spacing="0">
        <MudItem xs="8" sm="8" md="8">
            <div class="title">
                <MudAvatar Size="Size.Medium" Color="Color.Primary" Variant="Variant.Filled">
                    <MudIcon Icon="@Icons.Material.Filled.Description" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.h6">Purchase Orders</MudText>
                </div>
            </div>
        </MudItem>
        <MudItem xs="4" sm="4" md="4" Class="d-flex flex-column align-items-end">
            <div class="filter-actions">
                <MudTooltip Text="Open filters">
                    <MudIconButton Icon="@Icons.Material.Filled.FilterList" Color="Color.Primary" OnClick="@(() => _filtersOpen = !_filtersOpen)" />
                </MudTooltip>
                <MudTooltip Text="Export CSV">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportVisibleToCsv" StartIcon="@Icons.Material.Filled.Download">
                        Export
                    </MudButton>
                </MudTooltip>
            </div>
        </MudItem>
    </MudGrid>
   
</MudPaper>

<MudCollapse Expanded="_filtersOpen">
    <MudPaper Elevation="1" Class="pa-2 po-section">
        <div class="filters-grid">
            <div class="filters-row">
                <div class="filter-wrap">
                    <MudTextField T="string"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Typo="Typo.caption"
                                  Label="SAP PO No"
                                  Placeholder="SAP PO No"
                                  OnDebounceIntervalElapsed="@( (string s) => { sapPONo = s; return OnSearch(); } )"
                                  DebounceInterval="500"
                                  Margin="Margin.Dense"
                                  Class="filter-control" />
                </div>

                <div class="filter-wrap">
                    <MudTextField T="string"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Typo="Typo.caption"
                                  Label="Vendor"
                                  Placeholder="Vendor Name"
                                  Value="@vendorName"
                                  Margin="Margin.Dense"
                                  DebounceInterval="500"
                                  OnDebounceIntervalElapsed="@((string s) => { vendorName = s; return OnSearch(); })"
                                  Class="filter-control" />
                </div>

                <div class="filter-wrap">
                    <MudTextField T="string"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Typo="Typo.caption"
                                  Label="Project Code"
                                  Placeholder="Project Code"
                                  Value="@projectCode"
                                  Margin="Margin.Dense"
                                  DebounceInterval="500"
                                  OnDebounceIntervalElapsed="@((string s) => { projectCode = s; return OnSearch(); })"
                                  Class="filter-control" />
                </div>

                <div class="filter-wrap" style="max-width:120px;">
                    <MudTextField T="decimal?"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Typo="Typo.caption"
                                  Label="Min Total"
                                  InputType="InputType.Number"
                                  ValueChanged="@( (decimal? v) => { minTotalValue = v; return OnSearch(); } )"
                                  Placeholder="Min"
                                  Clearable="true"
                                  Margin="Margin.Dense"
                                  Class="filter-control" />
                </div>

                <div class="filter-wrap" style="max-width:120px;">
                    <MudTextField T="decimal?"
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Typo="Typo.caption"
                                  Label="Max Total"
                                  InputType="InputType.Number"
                                  ValueChanged="@( (decimal? v) => { maxTotalValue = v; return OnSearch(); } )"
                                  Placeholder="Max"
                                  Clearable="true"
                                  Margin="Margin.Dense"
                                  Class="filter-control" />
                </div>

                <div class="filter-wrap" style="min-width:170px; max-width:220px;">
                    <MudSelect T="string"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Label="Invoice Status"
                               Placeholder=""
                               Typo="Typo.caption"
                               Value="selectedInvoiceStatus"
                               ValueChanged="OnInvoiceStatusChanged"
                               Margin="Margin.Dense"
                               Class="filter-control">
                        @foreach (var status in invoiceStatuses)
                        {
                            <MudSelectItem Value="@status">@status</MudSelectItem>
                        }
                    </MudSelect>
                </div>

                <div class="filter-wrap" style="min-width:230px; max-width:320px;">
                    <div class="date-range-picker">
                        <MudIcon Class="date-icon" Icon="@Icons.Material.Filled.DateRange" />
                        <MudDateRangePicker @ref="_dateRangePicker"
                                            Variant="Variant.Outlined"
                                            Dense="true"
                                            DateRangeChanged="OnDateRangeSearch"
                                            Placeholder="Select date range"
                                            DateFormat="dd-MMM-yy"
                                            TitleDateFormat="MMMM dd"
                                            Margin="Margin.Dense"
                                            Clearable="true"
                                            AutoClose="true"
                                            Class="filter-control"
                                            Style="min-width:180px;" />
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearDateRange" StartIcon="@Icons.Material.Filled.Clear">
                            Clear
                        </MudButton>
                    </div>
                </div>
            </div>
        </div>
    </MudPaper>
</MudCollapse>

<MudPaper Class="pa-2 po-paper mt-3">
    <MudTable T="PurchaseOrderDto"
              ServerData="GetServerData"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              RightAlignSmall="true"
              Dense="true"
              @ref="_table"
              RowsPerPage="15"
              Virtualize=" true"
              Class="po-table mt-3"
              FixedHeader="true"
              FixedFooter="true"
              Striped="true">
        <HeaderContent>
            <MudTh Class="col-pono po-header-cell">PONo</MudTh>
            <MudTh Class="po-header-cell">PO.Date</MudTh>
            <MudTh Class="po-header-cell">Supplier</MudTh>
            <MudTh Class="po-header-cell">Project</MudTh>
            <MudTh Class="po-header-cell" Align="Align.Right">Item.Value</MudTh>
            <MudTh Class="po-header-cell" Align="Align.Right">Tax.Value</MudTh>
            <MudTh Class="po-header-cell" Align="Align.Right">Total.Value</MudTh>
            <MudTh Class="po-header-cell">Inv.Status</MudTh>
            <MudTh Class="po-header-cell"> Details </MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>
                <MudLink Typo="Typo.body2" Class="cell-link" Href="@($"ViewPurchaseOrder/{context.Id}")" Color="Color.Primary" Underline="Underline.Hover">
                    @context.SAPPONumber
                </MudLink>
            </MudTd>
            <MudTd DataLabel="PODate" Class="no-wrap">
                <MudText Typo="Typo.body2">
                    @FormatDate(context.SAPPODate)
                </MudText>
            </MudTd>
            <MudTd DataLabel="Vendor" Class="no-wrap">
                <MudText Typo="Typo.body2">
                    @context.VendorName
                </MudText>
            </MudTd>
            <MudTd DataLabel="ProjectID">
                <MudText Typo="Typo.body2">
                    @context.ProjectCode
                </MudText>
            </MudTd>
            <MudTd Align="Align.Right">
                <MudText Typo="Typo.subtitle2">
                    <CurrencyText Amount="@context.ItemValue" />
                </MudText>
            </MudTd>
            <MudTd Align="Align.Right">
                <MudText Typo="Typo.subtitle2">
                    <CurrencyText Amount="@context.GSTTotal" />
                </MudText>
            </MudTd>
            <MudTd Align="Align.Right" Class="total-col">
                <MudText Typo="Typo.subtitle2">
                    <CurrencyText Amount="@context.TotalValue" />
                </MudText>
            </MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetInvoiceChipColor(context.InvoiceStatus)" Variant="Variant.Filled">@context.InvoiceStatus</MudChip>
            </MudTd>
            <MudTd>
                <MudIconButton OnClick="@(() => ToggleRow(context.Id))"
                               Icon="@(IsRowExpanded(context.Id) ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Outlined.ArrowDropDown)"
                               Variant="Variant.Text"
                               Color="Color.Info"
                               Size="Size.Medium" />
            </MudTd>
        </RowTemplate>

        <ChildRowContent Context="row">
            @if (IsRowExpanded(row.Id))
            {
                <MudTd ColSpan="12" Class="child-row-td">
                    <MudPaper Class="pa-3 child-row-paper" Elevation="1">
                        <!-- Header row: compact PO meta + actions -->
                        <div class="child-row-actions d-flex justify-space-between align-center">
                            <div class="d-flex align-center po-meta">
                                <MudAvatar Size="Size.Medium" Color="Color.Primary" Variant="Variant.Filled" Class="me-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Description" />
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.subtitle1">@row.SAPPONumber</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@row.VendorName — @row.ProjectCode</MudText>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <MudButton Color="Color.Secondary" Variant="Variant.Outlined" Size="Size.Small" StartIcon="@Icons.Material.Filled.Visibility" OnClick="@(() => ShowInvoices(row.Id))">
                                    View Invoices
                                </MudButton>
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add"
                                           OnClick="@(() => newInvoice(row.VendorId, row.Id))"
                                           Disabled="@(!GetCanCreateInvoiceForRow(row) || isDetailsLoading || isActionInProgress)">
                                    Create Invoice
                                </MudButton>
                            </div>
                        </div>

                        <!-- Cards with compact KPIs -->
                        <MudGrid GutterSize="2" Class="child-row-grid">
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Elevation="0" Class="small-card">
                                    <div class="d-flex align-center gap-2">
                                        <MudAvatar Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                            <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Small" />
                                        </MudAvatar>
                                        <div>
                                            <div class="label">Invoiced</div>
                                            <div class="value"><CurrencyText Amount="@row.InvoicedTotal" /></div>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Count: @(row.InvoiceCount ?? 0)</MudText>
                                        </div>
                                    </div>
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Elevation="0" Class="small-card">
                                    <div class="d-flex align-center gap-2">
                                        <MudAvatar Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled">
                                            <MudIcon Icon="@Icons.Material.Filled.HourglassTop" Size="Size.Small" />
                                        </MudAvatar>
                                        <div>
                                            <div class="label">Under Review</div>
                                            <div class="value">
                                                <CurrencyText Amount="@(
                                                    (row.InvoicedTotal ?? 0m)
                                                    - ((row.ApprovedTotal ?? 0m) + (row.RejectedTotal ?? 0m))
                                                )" />
                                            </div>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Count: @(row.UnderReviewInvoiceCount ?? 0)</MudText>
                                        </div>
                                    </div>
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Elevation="0" Class="small-card">
                                    <div class="d-flex align-center gap-2">
                                        <MudAvatar Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                        </MudAvatar>
                                        <div>
                                            <div class="label">Approved</div>
                                            <div class="value"><CurrencyText Amount="@row.ApprovedTotal" /></div>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Invoices: @(row.ApprovedInvoiceCount ?? 0)</MudText>
                                        </div>
                                    </div>
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Elevation="0" Class="small-card">
                                    <div class="d-flex align-center gap-2">
                                        <MudAvatar Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">
                                            <MudIcon Icon="@Icons.Material.Filled.HighlightOff" Size="Size.Small" />
                                        </MudAvatar>
                                        <div>
                                            <div class="label">Rejected</div>
                                            <div class="value"><CurrencyText Amount="@row.RejectedTotal" /></div>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Count: @(row.RejectedInvoiceCount ?? 0)</MudText>
                                        </div>
                                    </div>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudTd>
            }
        </ChildRowContent>

        <PagerContent>
            <MudTablePager PageSizeOptions="@_pageSizeOption" RowsPerPageString="POs Per Page" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<BreadcrumbItem> _items = new()
    {
        new BreadcrumbItem("Home", href: "/", disabled: false),
        new BreadcrumbItem("Purchase Orders", href: "/POList", disabled: false),
    };

    // Controls
    private bool _filtersOpen = true;

    // Add these fields to fix CS0103 errors
    private bool CanCreateInvoice { get; set; } = true;
    private bool isDetailsLoading { get; set; } = false;
    private bool isActionInProgress { get; set; } = false;
}