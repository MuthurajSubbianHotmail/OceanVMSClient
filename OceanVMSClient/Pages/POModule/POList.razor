@page "/polist"
@using Entities.Models
@using Entities.Models.POModule
@using OceanVMSClient.Components
@using Shared.DTO.POModule
@using MudBlazor.Components
<MudBreadcrumbs Items="_items" Separator="/" />
<PageHeader Title="Purchase Orders" />
<MudTable T="PurchaseOrderDto"
          ServerData="GetServerData"
          Hover="true" Breakpoint="Breakpoint.Sm" RightAlignSmall="true"
          @ref="_table" RowsPerPage="15">
    <ToolBarContent>
        <MudGrid>
            <MudItem xs="12" sm="2">
                <MudSelect T="string" Label="Invoice Status" Value="selectedInvoiceStatus" ValueChanged="OnInvoiceStatusChanged" Dense="true" Class="mt-0">
                    @foreach (var status in invoiceStatuses)
                    {
                        <MudSelectItem Value="@status">@status</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudTextField T="string"
                              Label="SAP PO No"
                              OnDebounceIntervalElapsed="@( (string s) => { sapPONo = s; return OnSearch(); } )"
                              Placeholder="SAP PO No"
                              Clearable="true"
                              DebounceInterval="500"
                              Class="mt-0" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudTextField T="string"
                              Label="Vendor"
                              OnDebounceIntervalElapsed="@( (string s) => { vendorName = s; return OnSearch(); } )"
                              DebounceInterval="500"
                              Placeholder="Vendor Name"
                              Clearable="true"
                              Class="mt-0" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudNumericField T="decimal?"
                                 Label="Min Total Value"
                                 InputType="InputType.Number"
                                 ValueChanged="@( (decimal? v) => { minTotalValue = v; return OnSearch(); } )"
                                 DebounceInterval="500"
                                 Placeholder="Min PO Value"
                                 Clearable="true"
                                 InvertMouseWheel="true"
                                 Min="0"
                                 Step="1000"
                                 Class="mt-0" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudNumericField T="decimal?"
                                 Label="Max Total Value"
                                 InputType="InputType.Number"
                                 ValueChanged="@( (decimal? v) => { maxTotalValue = v; return OnSearch(); } )"
                                 Placeholder="Max PO Value"
                                 Clearable="true"
                                 InvertMouseWheel="true"
                                 Min="0"
                                 Step="1000"
                                 Class="mt-0" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDateRangePicker @ref="_dateRangePicker"
                                    DateRangeChanged="OnDateRangeSearch"
                                    DateFormat="dd-MMM-yy"
                                    TitleDateFormat="MMMM dd"
                                    Margin="Margin.Dense"
                                    Variant="Variant.Text"
                                    AutoClose="true"
                                    Label="PO Date"
                                    Clearable="true">
                    <PickerActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearDateRange">Clear</MudButton>
                    </PickerActions>
                </MudDateRangePicker>
            </MudItem>
        </MudGrid>
    </ToolBarContent>
    <HeaderContent>
        <MudTh Style="width:5%;">Type</MudTh>
        <MudTh Style="width:10%;">PONo</MudTh>
        <MudTh Style="width:10%;">PODate</MudTh>
        <MudTh Style="width:25%;">Supplier</MudTh>
        <MudTh Align="Align.Right" Style="width:15%;">Item Value</MudTh>
        <MudTh Align="Align.Right" Style="width:10%;">Tax Value</MudTh>
        <MudTh Align="Align.Right" Style="width:15%;">Total Value</MudTh>
        <MudTh Style="width:15%;">Inv Status</MudTh>
        <MudTh Style="width:5%;"></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            <MudText>@context.PoTypeName</MudText>
        </MudTd>
        <MudTd>
            <MudLink Href="@($"PODetails/{context.Id}")" Color="Color.Primary" Underline="Underline.Hover">
                @context.SAPPONumber
            </MudLink>
        </MudTd>
        <MudTd DataLabel="PODate">@FormatDate(context.SAPPODate)</MudTd>
        <MudTd DataLabel="Vendor">@context.VendorName</MudTd>
        <MudTd Align="Align.Right" DataLabel="Item Value">@context.ItemValue.ToString("N2")</MudTd>
        <MudTd Align="Align.Right" DataLabel="Tax Value">@context.GSTTotal.ToString("N2")</MudTd>
        <MudTd Align="Align.Right" DataLabel="Total PO Value">@context.TotalValue.ToString("N2")</MudTd>
        <MudTd>
            <MudText Color="@GetStatusColor(context.InvoiceStatus)" Typo="Typo.body2">
                @context.InvoiceStatus
            </MudText>

        </MudTd>

        <MudTd>
            <MudIconButton OnClick="@(() => ToggleRow(context.Id))"
                           Icon="@(IsRowExpanded(context.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Outlined.ArrowDropDown)"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Small" />
        </MudTd>
    </RowTemplate>
    <ChildRowContent Context="row">
        @if (IsRowExpanded(row.Id))
        {

            <MudTd ColSpan="9">
                <MudPaper Class="pa-1">
                    <MudText Typo="Typo.subtitle1" Color="Color.Tertiary">Additional Details</MudText>
                    <MudDivider Class="my-2" />
                    <MudGrid>
                        <MudItem xs="12" sm="12">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Project:</strong> @row.ProjectName</MudText>
                        </MudItem>
                    </MudGrid>
                    <MudDivider Class="my-2" />
                    <MudGrid>
                        <MudItem xs="12" sm="3">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Invoice Count:</strong> @row.PreviousInvoiceCount</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="3">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Invoiced Value:</strong> @row.PreviousInvoiceValue</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="3">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Invoiced Pending:</strong> @row.InvoiceBalanceValue</MudText>
                        </MudItem>
                        <MudItem xs="12" sm="3">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Paid Amount:</strong> @row.PaidValue</MudText>
                        </MudItem>

                    </MudGrid>

                </MudPaper>

            </MudTd>
        }
    </ChildRowContent>
    <PagerContent>
        <MudTablePager PageSizeOptions="@_pageSizeOption" RowsPerPageString="POs Per Page" />
    </PagerContent>
</MudTable>
@code {
    private List<BreadcrumbItem> _items = new()
    {
        new BreadcrumbItem("Home", href: "/", disabled: false),
        new BreadcrumbItem("Purchase Orders", href: "/POList", disabled: false),
    };

}