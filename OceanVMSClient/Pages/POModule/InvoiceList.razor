@page "/invoices"
@using MudBlazor.Components
@using Shared.DTO.POModule
@inject NavigationManager NavigationManager
@using OceanVMSClient.SharedComp.Components
@inject IJSRuntime JS
<PageNavigation Items="_items" />
<PageHeader Title="Invoices" Class="mb-0" />

<MudPaper Class="pa-4 invoice-paper">
    <MudPaper Elevation="1" Class="pa-3">
        <MudGrid GutterSize="2" AlignItems="AlignItems.Center">
            <MudItem xs="12" md="12">
                <MudGrid GutterSize="1">
                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="string" Label="Invoice Ref No" 
                                        Placeholder="Ref No"
                                      @bind-Value="invoiceRefNo"
                                      Typo="Typo.caption"
                                      DebounceInterval="300"
                                      OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                      Margin="Margin.Dense"
                                      Class="filter-control" />
                    </MudItem>

                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="string" Label="SAP PO No"
                                      Typo="Typo.caption"
                            Placeholder="SAP PO No"
                                      @bind-Value="sapPoNo"
                                      DebounceInterval="300"
                                      OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                      Margin="Margin.Dense"
                                      Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="string" Label="Vendor"
                                      Typo="Typo.caption"
                            Placeholder="Vendor"
                                      @bind-Value="vendorName"
                                      DebounceInterval="300"
                                      OnDebounceIntervalElapsed="@( (string s) => { vendorName = s; return OnSearch(); } )"
                                      Margin="Margin.Dense"
                                      Class="filter-control" />
                    </MudItem>

                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="decimal?"
                                      Typo="Typo.caption"
                            Label="Min Total"
                                         Placeholder="Min"
                                         InputType="InputType.Number"
                                         ValueChanged="@( (decimal? v) => { minInvoiceTotal = v; return OnSearch(); } )"
                                         Clearable="true"
                                      Margin="Margin.Dense"
                                         Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="decimal?" Label="Max Total"
                                         Placeholder="Max"
                                      Typo="Typo.caption"
                                         InputType="InputType.Number"
                                         ValueChanged="@( (decimal? v) => { maxInvoiceTotal = v; return OnSearch(); } )"
                                         Clearable="true"
                                         Margin="Margin.Dense"
                                         Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudDateRangePicker @ref="_dateRange_picker"
                                            DateRangeChanged="OnDateRangeSearch"
                                            DateFormat="dd-MMM-yy"
                                            TitleDateFormat="MMMM dd"
                                            Margin="Margin.Dense"
                                            Variant="Variant.Text"
                                            Label="Invoice Date"
                                            Clearable="true"
                                            AutoClose="true"
                                            Class="filter-control">
                            <PickerActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearDateRange">Clear</MudButton>
                            </PickerActions>
                        </MudDateRangePicker>
                    </MudItem>
                </MudGrid>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable T="InvoiceDto"
              ServerData="GetServerData"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              @ref="_table"
              RowsPerPage="15"
              Dense="true"
              Virtualize="true"
              Class="invoice-table mt-2">
        <HeaderContent>
            <MudTh Style="background-color: cornflowerblue;">Invoice.Ref</MudTh>
            <MudTh Style="background-color: cornflowerblue;">Inv.Date</MudTh>
            <MudTh Style="background-color: cornflowerblue;">Vendor</MudTh>
            <MudTh Style="background-color: cornflowerblue;">SAP.PO.No</MudTh>
            <MudTh Align="Align.Right" Style="background-color: cornflowerblue;">PO.Date</MudTh>
            <MudTh Align="Align.Right" Style="background-color: cornflowerblue;">PO.Total</MudTh>
            <MudTh Align="Align.Right" Style="background-color: cornflowerblue;">Invoice.Total</MudTh>
            <MudTh Style="background-color: cornflowerblue;">Inv.Status</MudTh>
            <MudTh Style="background-color: cornflowerblue;">Details</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>
                <MudLink Typo="Typo.caption" Href="@($"{invoiceViewPage}/{context.Id}")" Color="Color.Primary" Underline="Underline.Hover">
                    @context.InvoiceRefNo
                </MudLink>
            </MudTd>
            <MudTd Class="flex-md-nowrap no-wrap">
                <MudText Typo="Typo.caption" Class="no-wrap">
                    @FormatDate(context.InvoiceDate)
                </MudText>
            </MudTd>
            <MudTd>@context.VendorName</MudTd>
            <MudTd>
                <MudLink Typo="Typo.caption" Href="@($"ViewPurchaseOrder/{context.PurchaseOrderId}")" Color="Color.Primary" Underline="Underline.Hover">
                    @context.SAPPONumber
                </MudLink>
            </MudTd>
            <MudTd Align="Align.Right" Class="flex-nowrap">
                
                    @FormatDate(context.SAPPODate)
                
            </MudTd>
            <MudTd Align="Align.Right">
                <MudText Typo="Typo.caption">
                    <CurrencyText Amount="context.POTotalValue" />
                </MudText>
            </MudTd>
            <MudTd Align="Align.Right">
                <MudText Typo="Typo.caption">
                    <CurrencyText Amount="context.InvoiceTotalValue" />
                </MudText>

            </MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Typo="Typo.caption" Color="@GetInvoiceChipColor(context.InvoiceStatus)" Variant="Variant.Filled">
                    @context.InvoiceStatus
                </MudChip>
            </MudTd>
            
            <MudTd>
                <MudIconButton OnClick="@(() => ToggleRow(context.Id))"
                               Icon="@(IsRowExpanded(context.Id) ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Outlined.ArrowDropDown)"
                               Variant="Variant.Text"
                               Color="Color.Info"
                               Size="Size.Medium" />
            </MudTd>
        </RowTemplate>

        <ChildRowContent Context="row">
            @if (IsRowExpanded(row.Id))
            {
                <MudTd ColSpan="10">
                    <MudPaper Class="pa-1 child-row-paper" Elevation="0">
                        <MudGrid xs="12" sm="12">
                            <MudItem id="Project Details" xs="12" sm="3">
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Project Name</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Info">@row.ProjectName</MudText>
                                </MudItem>
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Remarks</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Info">@row.Remarks</MudText>
                                </MudItem>

                            </MudItem>
                            <MudItem id="PO Breakup" xs="12" sm="3">
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Po Value</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Tertiary"><CurrencyText Amount="@row.POValue" /></MudText>
                                </MudItem>
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Po Tax Value</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Tertiary"><CurrencyText Amount="@row.POTaxValue" /></MudText>
                                </MudItem>
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Po Total Value</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Info"><CurrencyText Amount="@row.POTotalValue" /></MudText>
                                </MudItem>
                            </MudItem>
                            <MudItem id="Invoice Breakup" xs="12" sm="3">
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Invoice Value</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Tertiary">
                                        <CurrencyText Amount="@row.InvoiceValue" />
                                    </MudText>
                                </MudItem>
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Invoice Tax Value</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Tertiary">
                                        <CurrencyText Amount="@row.InvoiceTaxValue" />
                                    </MudText>
                                </MudItem>
                                <MudItem>
                                    <MudText Typo="Typo.subtitle2">Invoice Total Value</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Info">
                                        <CurrencyText Amount="@row.InvoiceTotalValue" />
                                    </MudText>
                                </MudItem>



                            </MudItem>
                            <MudItem id="Invoice Status" xs="12" sm="3">
                                <MudItem>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Preview"
                                               OnClick="@(() => NavigationManager.NavigateTo($"/invoiceview/{row.Id}"))"
                                               Style="width: 200px;">
                                        View Invoice
                                    </MudButton>
                                </MudItem>
                                <MudDivider Class="my-2" />
                                <MudItem>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Download"
                                               OnClick="@(async () => { if (!string.IsNullOrWhiteSpace(row.InvoiceFileURL)) await JS.InvokeVoidAsync("open", row.InvoiceFileURL, "_blank"); })"
                                               Disabled="@(string.IsNullOrWhiteSpace(row.InvoiceFileURL))"
                                               Style="width: 200px;">
                                        Download Invoice
                                    </MudButton>
                                </MudItem>
                            </MudItem>

                        </MudGrid>
                    </MudPaper>
                </MudTd>
            }
        </ChildRowContent>

        <PagerContent>
            <MudTablePager PageSizeOptions="@_pageSize_option" RowsPerPageString="Invoices Per Page" />
        </PagerContent>

    </MudTable>
    <MudDivider Class="mt-2" />
    <MudItem xs="12" Class="d-flex justify-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportVisibleToCsv">
            Export CSV
        </MudButton>
    </MudItem>

    @* <MudGrid>
        <MudItem xs="12" Class="d-flex justify-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateNewInvoice">New Invoice</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="ml-2" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateNewInvoiceFromPo">New Invoice (From PO)</MudButton>
        </MudItem>
    </MudGrid> *@
</MudPaper>

@code {
    private List<BreadcrumbItem> _items = new()
    {
        new BreadcrumbItem("Home", href: "/", disabled: false),
        new BreadcrumbItem("Invoices", href: "/invoices", disabled: true),
    };

    private MudTable<InvoiceDto>? _table;
    private MudDateRangePicker? _dateRange_picker;
    private DateRange? _invoice_date_range;

    // filter fields
    private string? invoiceRefNo;
    private string? sapPoNo;
    private decimal? minInvoiceTotal;
    private decimal? maxInvoiceTotal;
    private string? vendorName;

    private readonly int[] _pageSize_option = { 15, 25, 50 };

    private string FormatDate(DateTime? date)
    {
        return date.HasValue ? date.Value.ToString("dd-MMM-yy") : string.Empty;
    }

    private void CreateNewInvoice()
    {
        NavigationManager.NavigateTo("/newinvoice");
    }

    // Navigates to the same create page with a query parameter that your create page can use to open PO selector if desired.
    private void CreateNewInvoiceFromPo()
    {
        NavigationManager.NavigateTo("/newinvoice");
    }
}