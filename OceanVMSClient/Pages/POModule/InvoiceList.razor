@page "/invoices"
@using MudBlazor.Components
@using Shared.DTO.POModule
@inject NavigationManager NavigationManager

<MudBreadcrumbs Items="_items" Separator="/" Class="mb-0" />
<PageHeader Title="Invoices" Class="mb-0" />

<MudPaper Class="pa-4 invoice-paper">
    <MudPaper Elevation="0" Class="pa-3 section">
        <MudGrid GutterSize="2" AlignItems="AlignItems.Center">
            <MudItem xs="12" md="12">
                <MudGrid GutterSize="1">
                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="string" Label="Invoice Ref No" Placeholder="Ref No"
                                      @bind-Value="invoiceRefNo"
                                      DebounceInterval="300"
                                      OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                      Dense="true" Class="filter-control" />
                    </MudItem>

                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="string" Label="SAP PO No" Placeholder="SAP PO No"
                                      @bind-Value="sapPoNo"
                                      DebounceInterval="300"
                                      OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                      Dense="true" Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudTextField T="string" Label="Vendor" Placeholder="Vendor"
                                      @bind-Value="vendorName"
                                      DebounceInterval="300"
                                      OnDebounceIntervalElapsed="@( (string s) => { vendorName = s; return OnSearch(); } )"
                                      Dense="true" Class="filter-control" />
                    </MudItem>

                    <MudItem xs="12" sm="2" md="2">
                        <MudNumericField T="decimal?" Label="Min Total" 
                            Placeholder="Min"
                                         InputType="InputType.Number"
                                         ValueChanged="@( (decimal? v) => { minInvoiceTotal = v; return OnSearch(); } )"
                                         Clearable="true"
                                         Dense="true"
                                         Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudNumericField T="decimal?" Label="Max Total" 
                                         InputType="InputType.Number"
                                         ValueChanged="@( (decimal? v) => { maxInvoiceTotal = v; return OnSearch(); } )"
                                         Clearable="true"
                                         Dense="true"
                                         Class="filter-control" />
                    </MudItem>
                    <MudItem xs="12" sm="2" md="2">
                        <MudDateRangePicker @ref="_dateRange_picker"
                                            DateRangeChanged="OnDateRangeSearch"
                                            DateFormat="dd-MMM-yy"
                                            TitleDateFormat="MMMM dd"
                                            Margin="Margin.Dense"
                                            Variant="Variant.Text"
                                            Dense="true"
                                            Label="Invoice Date"
                                            Clearable="true"
                                            AutoClose="true"
                                            Class="filter-control">
                            <PickerActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearDateRange">Clear</MudButton>
                            </PickerActions>
                        </MudDateRangePicker>
                    </MudItem>
                </MudGrid>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable T="InvoiceDto"
              ServerData="GetServerData"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              @ref="_table"
              RowsPerPage="15"
              Class="invoice-table mt-3">
        <HeaderContent>
            <MudTh>Invoice Ref</MudTh>
            <MudTh>Invoice Date</MudTh>
            <MudTh>Vendor</MudTh>
            <MudTh>SAP PO No</MudTh>
            <MudTh Align="Align.Right">PO Date</MudTh>
            <MudTh Align="Align.Right">PO Total</MudTh>
            <MudTh Align="Align.Right">Invoice Total</MudTh>
            <MudTh>Invoice Status</MudTh>
            <MudTh>Payment Status</MudTh>
            <MudTh></MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>
                <MudLink Href="@($"invoiceview/{context.Id}")" Color="Color.Primary" Underline="Underline.Hover">
                    @context.InvoiceRefNo
                </MudLink>
            </MudTd>
            <MudTd>@FormatDate(context.InvoiceDate)</MudTd>
            <MudTd>@context.VendorName</MudTd>
            <MudTd>
                <MudLink Href="@($"ViewPurchaseOrder/{context.PurchaseOrderId}")" Color="Color.Primary" Underline="Underline.Hover">
                    @context.SAPPONumber
                </MudLink>
            </MudTd>
            <MudTd Align="Align.Right">@FormatDate(context.SAPPODate)</MudTd>
            <MudTd Align="Align.Right">@($"{context.POTotalValue:N2}")</MudTd>
            <MudTd Align="Align.Right">@($"{context.InvoiceTotalValue:N2}")</MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetInvoiceChipColor(context.InvoiceStatus)" Variant="Variant.Filled">@context.InvoiceStatus</MudChip>
            </MudTd>
            <MudTd>@context.PaymentStatus</MudTd>
            <MudTd>
                <MudIconButton OnClick="@(() => ToggleRow(context.Id))"
                               Icon="@(IsRowExpanded(context.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Outlined.ArrowDropDown)"
                               Variant="Variant.Filled"
                               Color="Color.Default"
                               Size="Size.Small" />
            </MudTd>
        </RowTemplate>

        <ChildRowContent Context="row">
            @if (IsRowExpanded(row.Id))
            {
                <MudTd ColSpan="10">
                    <MudPaper Class="pa-3 child-row-paper" Elevation="0">
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">Invoice & PO Details</MudText>
                        <MudDivider Class="my-2" />

                        <MudGrid GutterSize="2">
                            <MudItem xs="12" sm="6" md="4">
                                <div class="field-pair">
                                    <div class="field-label">Invoice Ref No</div>
                                    <div class="field-value"><strong>@row.InvoiceRefNo</strong></div>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="4">
                                <div class="field-pair">
                                    <div class="field-label">Invoice Date</div>
                                    <div class="field-value">@FormatDate(row.InvoiceDate)</div>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="4">
                                <div class="field-pair">
                                    <div class="field-label">SAP PO No</div>
                                    <div class="field-value">
                                        <MudLink Href="@($"ViewPurchaseOrder/{row.PurchaseOrderId}")" Color="Color.Primary" Underline="Underline.Hover">
                                            <strong>@row.SAPPONumber</strong>
                                        </MudLink>
                                    </div>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="4">
                                <div class="field-pair">
                                    <div class="field-label">PO Date</div>
                                    <div class="field-value">@FormatDate(row.SAPPODate)</div>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="4">
                                <div class="field-pair">
                                    <div class="field-label">Project Code</div>
                                    <div class="field-value">@row.ProjectCode</div>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="6" md="4">
                                <div class="field-pair">
                                    <div class="field-label">Remarks</div>
                                    <div class="field-value">@row.Remarks</div>
                                </div>
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-2" />

                        <MudGrid GutterSize="2" Class="mb-2">
                            <MudItem xs="6" sm="4" md="3">
                                <div class="child-stat">
                                    <div class="stat-label-small">PO Value</div>
                                    <div class="stat-value">@($"{row.POValue:N2}")</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6" sm="4" md="3">
                                <div class="child-stat">
                                    <div class="stat-label-small">PO Tax</div>
                                    <div class="stat-value">@($"{row.POTaxValue:N2}")</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6" sm="4" md="3">
                                <div class="child-stat">
                                    <div class="stat-label-small">PO Total</div>
                                    <div class="stat-value po-total-value">@($"{row.POTotalValue:N2}")</div>
                                </div>
                            </MudItem>

                            <MudItem xs="6" sm="4" md="3">
                                <div class="child-stat">
                                    <div class="stat-label-small">Invoice Value</div>
                                    <div class="stat-value">@($"{row.InvoiceValue:N2}")</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6" sm="4" md="3">
                                <div class="child-stat">
                                    <div class="stat-label-small">Invoice Tax</div>
                                    <div class="stat-value">@($"{row.InvoiceTaxValue:N2}")</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6" sm="4" md="3">
                                <div class="child-stat">
                                    <div class="stat-label-small">Invoice Total</div>
                                    <div class="stat-value invoice-total-value">@($"{row.InvoiceTotalValue:N2}")</div>
                                </div>
                            </MudItem>

                            <MudItem xs="6" sm="4" md="3">
                                <div class="child-stat">
                                    <div class="stat-label-small">Paid</div>
                                    <div class="stat-value paid-value">@($"{row.PaidValue:N2}")</div>
                                </div>
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-2" />

                        <MudGrid GutterSize="2" AlignItems="AlignItems.Center">
                            <MudItem xs="12" sm="6">
                                <div class="field-pair">
                                    <div class="field-label">Invoice File</div>
                                    @if (!string.IsNullOrWhiteSpace(row.InvoiceFileURL))
                                    {
                                        <div class="field-value">
                                            <MudLink Href="@row.InvoiceFileURL" Target="_blank" Color="Color.Primary" Underline="Underline.Hover">
                                                Open Attachment
                                            </MudLink>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="field-value">—</div>
                                    }
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="3">
                                <div class="field-pair">
                                    <div class="field-label">Invoice Status</div>
                                    <div class="field-value"><MudChip T="string" Size="Size.Small" Color="@GetInvoiceChipColor(row.InvoiceStatus)" Variant="Variant.Filled">@row.InvoiceStatus</MudChip></div>
                                </div>
                            </MudItem>

                            <MudItem xs="12" sm="3">
                                <div class="field-pair">
                                    <div class="field-label">Payment Status</div>
                                    <div class="field-value">@row.PaymentStatus</div>
                                </div>
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-2" />

                        <!-- Workflow stepper -->
                        <MudStepper Elevation="0" ActiveIndex="@GetWorkflowStepIndex(row.InvoiceStatus)" Class="mt-3 child-stepper" hidden="hidden">
                            <MudStep Label="Submitted" />
                            <MudStep Label="Initiator" />
                            <MudStep Label="Checker" />
                            <MudStep Label="Validator" />
                            <MudStep Label="Approver" />
                            <MudStep Label="Accounts Payable" />
                            <MudStep Label="Paid" />
                        </MudStepper>
                     </MudPaper>
                 </MudTd>
             }
         </ChildRowContent>

        <PagerContent>
            <MudTablePager PageSizeOptions="@_pageSize_option" RowsPerPageString="Invoices Per Page" />
        </PagerContent>
    </MudTable>
    <MudDivider Class="my-3" />

    <MudGrid>
        <MudItem xs="12" Class="d-flex justify-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateNewInvoice">New Invoice</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="ml-2" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateNewInvoiceFromPo">New Invoice (From PO)</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    private List<BreadcrumbItem> _items = new()
    {
        new BreadcrumbItem("Home", href: "/", disabled: false),
        new BreadcrumbItem("Invoices", href: "/invoices", disabled: true),
    };

    private MudTable<InvoiceDto>? _table;
    private MudDateRangePicker? _dateRange_picker;
    private DateRange? _invoice_date_range;

    // filter fields
    private string? invoiceRefNo;
    private string? sapPoNo;
    private decimal? minInvoiceTotal;
    private decimal? maxInvoiceTotal;
    private string? vendorName;

    private readonly int[] _pageSize_option = { 15, 25, 50 };

    private string FormatDate(DateTime? date)
    {
        return date.HasValue ? date.Value.ToString("dd-MMM-yy") : string.Empty;
    }

    private void CreateNewInvoice()
    {
        NavigationManager.NavigateTo("/newinvoice");
    }

    // Navigates to the same create page with a query parameter that your create page can use to open PO selector if desired.
    private void CreateNewInvoiceFromPo()
    {
        NavigationManager.NavigateTo("/newinvoice");
    }
}