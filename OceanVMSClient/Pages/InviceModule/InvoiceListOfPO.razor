@page "/InvoiceListOfPO/{PurchaseOrderId:guid}"
@using Shared.DTO.POModule
@using MudBlazor
@inject NavigationManager NavManager

<style>
    /* Container styling */
    .modal-paper {
        width: 100%;
        max-width: 100%;
        height: 100vh;
        max-height: none;
        box-sizing: border-box; /* ensure padding is included in width/height */
        overflow: hidden;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        padding: 1rem;
        background: linear-gradient(180deg, rgba(250,250,250,1) 0%, rgba(245,247,250,1) 100%);
    }

    /* Header */
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex: 0 0 auto;
        gap: 1rem;
    }

    .title-area {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .po-summary {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
        flex: 0 0 auto;
        margin-top: 0.5rem;
    }

    .po-summary .item {
        font-size: 0.95rem;
        color: var(--mud-palette-text-primary);
        background: rgba(255,255,255,0.6);
        padding: 0.35rem 0.6rem;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }

    /* Controls area (search / filters / actions) */
    .controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .table-container {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        margin-top: 0.75rem;
        padding: 0.25rem;
    }

    /* Table: full width, sticky header and zebra rows */
    .table-container .mud-table-root,
    .table-container table {
        width: 100% !important;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0 8px;
        box-sizing: border-box; /* make sure widths include padding/borders */
    }

    .table-container thead th {
        position: sticky;
        top: 0;
        background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,250,0.95));
        backdrop-filter: blur(6px);
        z-index: 2;
        padding: 0.6rem 0.75rem;
        border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .table-container tbody tr {
        background: white;
        border-radius: 6px;
        transition: transform .06s ease, box-shadow .06s ease;
    }

    .table-container tbody tr:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(17,24,39,0.06);
        cursor: pointer;
    }

    .table-container td, .table-container th {
        white-space: normal !important;
        overflow-wrap: anywhere;
        word-break: break-word;
        vertical-align: middle;
        padding: 0.5rem 0.75rem;
    }

    .vendor-avatar {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg,#5b86e5,#36d1dc);
        margin-right: 0.5rem;
    }

    .meta-row {
        display:flex;
        gap:0.75rem;
        align-items:center;
    }

    .no-data {
        padding: 2rem;
        text-align: center;
    }

    @@media (max-width: 720px) {
        .po-summary { font-size: 0.85rem; gap: 0.5rem; }
        .controls { flex-direction: column; align-items: stretch; }
    }
</style>

<MudPaper Class="modal-paper pa-4" Elevation="6">
    <div class="modal-header">
        <div class="title-area">
            <MudText Typo="Typo.h6">Invoices for Purchase Order</MudText>
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@PoNumberText</MudText>
        </div>

        <div style="display:flex;gap:0.5rem;align-items:center;">
            <MudIconButton Icon="@Icons.Material.Filled.FileDownload" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Medium" Disabled="true" Title="Export (coming soon)" />
            <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" Variant="Variant.Text" OnClick="Close" />
        </div>
    </div>

    @if (isLoading)
    {
        <div style="display:flex;align-items:center;justify-content:center;min-height:220px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else
    {
        <div class="po-summary">
            <div class="item"><strong>PO Date:</strong> @PoDateText</div>
            <div class="item"><strong>Supplier:</strong> @VendorText</div>
            <div class="item"><strong>PO Total:</strong> @TotalValueText</div>
            <div class="item"><strong>Invoice Balance:</strong> @InvoiceBalanceValueText</div>
            <div class="item"><strong>Invoices:</strong> @_invoices?.Count</div>
        </div>

        <div class="controls">
            <MudTextField @bind-Value="searchTerm" Placeholder="Search by ref, vendor, SAP PO..." Immediate="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Class="mud-width-full" Style="min-width:200px;max-width:420px;" />
            <MudSelect T="string" @bind-Value="selectedStatus" Class="mud-width-auto" Style="min-width:140px;">
                <MudSelectItem Value="@("All")">All Status</MudSelectItem>
                @if (_invoices != null)
                {
                    foreach (var s in _invoices.Select(i => i.InvoiceStatus).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct())
                    {
                        <MudSelectItem Value="@s">@s</MudSelectItem>
                    }
                }
            </MudSelect>

            <MudSpacer />

            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="RefreshList">Refresh</MudButton>
        </div>

        <div class="table-container">
            <MudTable T="InvoiceDto" Items="FilteredInvoices" Dense="true" Hover="true" Elevation="0" Class="mb-2" Breakpoint="Breakpoint.Sm" RowClick="OnRowClick">
                <HeaderContent>
                    <MudTh Style="width:15%">Ref No</MudTh>
                    <MudTh Style="width:10%">Inv.Date</MudTh>
                    <MudTh Style="width:15%">Vendor</MudTh>
                    <MudTh Style="width:10%">SAP.PO.No</MudTh>
                    <MudTh Align="Align.Right" Style="width:10%">PO.Date</MudTh>
                    <MudTh Align="Align.Right" Style="width:10%">Invoice.Total</MudTh>
                    <MudTh Style="width:10%">Inv.Status</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <div class="meta-row">
                            <div class="vendor-avatar" title="@context.VendorName">@GetVendorInitial(context.VendorName)</div>
                            <div>
                                <MudText Typo="Typo.subtitle2"><MudLink Href="@($"{invoiceViewPage}/{context.Id}")" Color="Color.Primary" Underline="Underline.Hover">@context.InvoiceRefNo</MudLink></MudText>
                            </div>
                        </div>
                    </MudTd>
                    <MudTd>@FormatDate(context.InvoiceDate)</MudTd>
                    <MudTd>@context.VendorName</MudTd>
                    <MudTd>
                        <MudLink Href="@($"ViewPurchaseOrder/{context.PurchaseOrderId}")" Color="Color.Primary" Underline="Underline.Hover">@context.SAPPONumber</MudLink>
                    </MudTd>
                    <MudTd Align="Align.Right">@FormatDate(context.SAPPODate)</MudTd>
                    <MudTd Align="Align.Right"><CurrencyText Amount="context.InvoiceTotalValue" /></MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Color="@GetInvoiceChipColor(context.InvoiceStatus)" Variant="Variant.Filled">@context.InvoiceStatus</MudChip>
                    </MudTd>
                </RowTemplate>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>

            @if (_invoices == null || !_invoices.Any())
            {
                <div class="no-data">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No invoices found for this purchase order.</MudText>
                </div>
            }
        </div>
    }
</MudPaper>

@code {
    private string searchTerm = string.Empty;
    private string selectedStatus = "All";

    private IEnumerable<InvoiceDto> FilteredInvoices => (_invoices ?? Enumerable.Empty<InvoiceDto>())
        .Where(i =>
        {
            var matchSearch = string.IsNullOrWhiteSpace(searchTerm)
                || (i.InvoiceRefNo?.Contains(searchTerm, StringComparison.InvariantCultureIgnoreCase) ?? false)
                || (i.VendorName?.Contains(searchTerm, StringComparison.InvariantCultureIgnoreCase) ?? false)
                || (i.SAPPONumber?.Contains(searchTerm, StringComparison.InvariantCultureIgnoreCase) ?? false);

            var matchStatus = selectedStatus == "All" || string.IsNullOrWhiteSpace(selectedStatus)
                ? true
                : string.Equals(i.InvoiceStatus, selectedStatus, StringComparison.InvariantCultureIgnoreCase);

            return matchSearch && matchStatus;
        })
        .OrderByDescending(i => i.InvoiceDate);

    private void OnRowClick(TableRowClickEventArgs<InvoiceDto> args)
    {
        if (args?.Item != null)
            NavManager.NavigateTo($"{invoiceViewPage}/{args.Item.Id}");
    }

    private void RefreshList()
    {
        // Trigger reload logic already present in the page - if you have a method e.g., LoadInvoicesAsync, call it here.
        // If there's an existing reload mechanism in the code-behind, replace this stub with that call.
        StateHasChanged();
    }

    private string GetVendorInitial(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0].Substring(0, 1).ToUpperInvariant();
        return (parts[0].Substring(0, 1) + parts[1].Substring(0, 1)).ToUpperInvariant();
    }
}
