@using MudBlazor

<MudPaper Class="pa-4">
    <EditForm EditContext="_editContext">
        <DataAnnotationsValidator />
        

        <MudGrid GutterSize="2" AlignItems="Center" Spacing="1">
            <!-- Left column: reviewer & invoice meta -->
            <MudItem xs="12" sm="6">
                <MudPaper Elevation="2" Class="pa-2 me-2">
                    <MudGrid GutterSize="1" Spacing="1" AlignItems="Center">
                        <MudItem xs="12" sm="8" Class="field-block">
                            <MudText Typo="Typo.subtitle2" Color="_labelColor">Reviewer</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Info" Class="mb-1">
                                @(_invoiceDto?.ApproverName ?? "—")
                            </MudText>
                        </MudItem>

                        <MudItem xs="12" sm="4" Class="field-block">
                            <MudText Typo="Typo.subtitle2" Color="_labelColor">Review Date</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Info">
                                @(_invoiceDto?.ApproverReviewDate is DateTime rd ? rd.ToString("dd-MMM-yyyy") : "—")
                            </MudText>
                        </MudItem>

                        <MudDivider />

                        <CurrentInvoiceComponent InvoiceRefNo="@(_invoiceDto?.InvoiceRefNo)"
                                                 InvoiceDate="@(_invoiceDto?.InvoiceDate)"
                                                 InvoiceValue="@(_invoiceDto?.InvoiceValue)"
                                                 InvoiceTaxValue="@(_invoiceDto?.InvoiceTaxValue)"
                                                 InvoiceTotalValue="@(_invoiceDto?.InvoiceTotalValue)"
                                                 PrevReviewerName="@_previousReviewInfo.PreviousReviewerName"
                                                 PrevApprovedAmount="@_previousReviewInfo.PrevApprovedAmount"
                                                 PrevWithheldAmount="@_previousReviewInfo.PrevWithheldAmount" />

                        <MudDivider />

                        <!-- Approved / Withheld fields: stack on mobile, side-by-side on sm+ -->

                        <MudItem xs="6" sm="4" Class="field-block">
                            <MudSelect Label="Approval"
                                       Typo="Typo.caption"
                                       Value="_approverCompleteDto.ApproverReviewStatus"
                                       ValueChanged="@(EventCallback.Factory.Create<string>(this, OnApproverReviewStatusChanged))"
                                       Variant="@_variant"
                                       Margin="Margin.Dense"
                                       Class="short-field"
                                       Disabled="!CanEditApprovedAmount()"
                                       Required="true">
                                <MudSelectItem Value="@("Approved")">Approved</MudSelectItem>
                                <MudSelectItem Value="@("Rejected")">Rejected</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4" Class="field-block">
                            <MudTextField T="decimal?"
                                          Label="Approved Amount"
                                          Placeholder=""
                                          Typo="Typo.caption"
                                          Value="_approverCompleteDto.ApproverApprovedAmount"
                                          ValueChanged="@(EventCallback.Factory.Create<decimal?>(this, OnApproverApprovedAmountChanged))"
                                          Variant="@_variant"
                                          Adornment="Adornment.Start"
                                          AdornmentText="₹"
                                          Margin="@_margin"
                                          Class="short-field"
                                          ReadOnly="!CanEditApprovedAmount()" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4" Class="field-block">
                            <MudTextField T="decimal?"
                                          Label="Withheld Amount"
                                          Placeholder=""
                                          Typo="Typo.caption"
                                          Value="_approverCompleteDto.ApproverWithheldAmount"
                                          Variant="@_variant"
                                          Adornment="Adornment.Start"
                                          AdornmentText="₹"
                                          Margin="@_margin"
                                          Class="short-field"
                                          ReadOnly="true" />
                        </MudItem>

                        <MudItem xs="12" Class="field-block">
                            <MudTextField Label="Withheld Reason"
                                          Placeholder="Withheld Reason"
                                          Typo="Typo.caption"
                                          Value="_approverCompleteDto.ApproverWithheldReason"
                                          ValueChanged="@(EventCallback.Factory.Create<string>(this, v => _approverCompleteDto.ApproverWithheldReason = v))"
                                          Variant="@_variant"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="Icons.Material.Filled.Info"
                                          Margin="@_margin"
                                          ReadOnly="!CanEditApprovedAmount()"
                                          OnBlur="OnApproverWithheldReasonBlur" />
                            <ValidationMessage For="@(() => _approverCompleteDto.ApproverWithheldReason)" />
                        </MudItem>

                        <MudItem xs="12" Class="field-block">
                            <MudTextField Label="Remarks"
                                          Placeholder="Remarks"
                                          Typo="Typo.caption"
                                          Value="_approverCompleteDto.ApproverReviewComment"
                                          ValueChanged="@(EventCallback.Factory.Create<string>(this, v => _approverCompleteDto.ApproverReviewComment = v))"
                                          Variant="@_variant"
                                          Margin="@_margin"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="Icons.Material.Filled.Info"
                                          Lines="2"
                                          ReadOnly="!CanEditApprovedAmount()" />
                        </MudItem>

                        
                        <MudItem xs="6" sm="6" Class="d-flex justify-end align-content-center">
                            <InvFileUploader DocType="ApproverAttachment"
                                             OnChange="OnSupportingFileUploaded"
                                             Disabled="@(!CanEditApprovedAmount())"
                                             Label="Supporting Document" />

                        </MudItem>
                        <MudItem xs="6" sm="6" Class="field-block" />

                        <MudItem xs="6" sm="6" Class="d-flex justify-end align-content-center">
                            <MudLink Href="@_invoiceDto.ApproverReviewAttachment">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Download"
                                           Disabled="@string.IsNullOrEmpty(_invoiceDto?.ApproverReviewAttachment)">
                                    Download Attachment
                                </MudButton>
                            </MudLink>

                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <!-- Right column: PO & SLA summary -->
            <MudItem xs="12" sm="6">
                <InvStatusComponent _invoiceDto="_invoiceDto"
                                    _PODto="_PODto"
                                    CurrentTab="Approver"
                                    AssignmentDate="@(_invoiceDto?.ApproverReviewAssigedOn?.ToString("dd-MMM-yyyy") ?? string.Empty)"
                                    SLADays="@_invoiceDto?.ApproverReviewSLADays"
                                    TargetDate="@(_invoiceDto?.ApproverReviewTargetDate?.ToString("dd-MMM-yyyy") ?? string.Empty)"
                                    SLAStatus="@_invoiceDto?.ApproverReviewSLAStatus"
                                    ReviewStatus="@_invoiceDto?.ApproverReviewStatus" />
            </MudItem>

            <MudItem xs="12" Class="actions mt-2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="SaveDecision"
                           Disabled="@IsReadOnly">
                    Submit Review
                </MudButton>
            </MudItem>
        </MudGrid>
        <ValidationSummary />
    </EditForm>
</MudPaper>
@code {
    private Variant _variant = Variant.Outlined;
    private Margin _margin = Margin.Dense;
    private Color _labelColor = Color.Info;
}
