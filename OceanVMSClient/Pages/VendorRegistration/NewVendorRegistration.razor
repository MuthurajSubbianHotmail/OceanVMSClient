@page "/vendor-registration/{VendorRegistrationFormId:guid}"
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using OceanVMSClient.Extensions
@using System.Globalization

<MudBreadcrumbs Items="_items" Separator="/" Class="mb-0" />
<PageHeader Title="New Vendor Registration" Class="mb-0" />

<MudCard Class="pa-1" Elevation="1">
    <MudCardContent>
        <!-- EditForm: perform validation manually in the handler so we can show dialog-only -->
        <EditForm EditContext="_editContext" OnSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <MudStepper NonLinear="true" @bind-ActiveIndex="ActiveStep" ShowResetButton="true" ShowButtons="true">
                <MudStep Title="Organization Info" Label="Step 1" Icon="@Icons.Material.Filled.Filter1"
                         @bind-Completed="_completed" HasError="true">
                    <!-- Make items equal height -->
                    <MudGrid GutterSize="1" AlignItems="center" Spacing="0">

                        <MudItem md="4" Class="h-150">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">

                                <MudGrid Spacing="0" GutterSize="1" AlignItems="center">
                                    <MudText Typo="Typo.h6" Color="Color.Info">Organization Information</MudText>
                                    <MudDivider Class="mx-2" />

                                    <MudItem xs="12">
                                        <MudTextField Label="Organization Name"
                                                      Placeholder="Oganization Name"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.OrganizationName"
                                                      HelperTextOnFocus="true"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.OrganizationName)"
                                                      Disabled="@_isReadOnly"
                                                      For="@(() => _vendorReg.OrganizationName)"/>

                                    </MudItem>
                                    <MudItem xs="8">
                                        @if (_companyOwnerships?.Any() == true)
                                        {
                                            <MudSelect T="string"
                                                       @bind-Value="@_vendorReg.CompanyOwnershipType"
                                                       SelectedValuesChanged="OnCompanyOwnershipChanged"
                                                       Placeholder="Company Ownership"
                                                       Typo="@_inputTypo"
                                                       Label="Company Ownership"
                                                       Variant="Variant.Text"
                                                       FullWidth="true"
                                                       Margin="Margin.Dense"
                                                       Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.CompanyOwnershipType)"
                                                       Disabled="@_isReadOnly">
                                                @foreach (var ownership in _companyOwnerships)
                                                {
                                                    <MudSelectItem Value="@(ownership.CompanyOwnershipType)">
                                                        @ownership.CompanyOwnershipType
                                                    </MudSelectItem>
                                                }
                                            </MudSelect>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.caption">Loading ownerships…</MudText>
                                        }

                                    </MudItem>
                                    <MudItem xs="4">
                                        <MudSwitch Color="Color.Primary" T="bool" Value="_IsMSMERegistered" ValueChanged="@(HandleMSMSSelectdChange)">
                                            <MudText Typo="Typo.caption">Is MSME?</MudText>
                                        </MudSwitch>
                                    </MudItem>
                                    <MudItem xs="12">
                                       @*  <MudSelect T="string"
                                                   Label="Services Offered"
                                                   Placeholder="Services Offered"
                                                   Typo="@_inputTypo"
                                                   Variant="Variant.Text"
                                                   FullWidth="true"
                                                   Margin="Margin.Dense"
                                                   @bind-Value="@_vendorReg.VendorType"
                                                   MultiSelection="true"
                                                   @bind-SelectedValues="@_selectedServices"
                                                   Required="true"
                                                   RequiredError="Please Select the Services Offered"
                                                   Disabled="@_isReadOnly"
                                                   OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.VendorType)))">
                                            @foreach (var vType in _vendorServices)
                                            {
                                                <MudSelectItem Value="@(vType.VendorServiceName)">
                                                    @vType.VendorServiceName
                                                </MudSelectItem>
                                            }

                                        </MudSelect> *@
                                    </MudItem>
                                    <MudItem xs="12">

                                        <MudTextField T="string"
                                                      Label="Company Phone"
                                                      Placeholder="Phone Number"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      InputType="InputType.Telephone"
                                                      Format="(##) #####-#####"
                                                      @bind-Value="@_vendorReg.CompanyPhoneNo"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.CompanyPhoneNo)"
                                                      Disabled="@_isReadOnly"
                                                      For="@(() => _vendorReg.CompanyPhoneNo)" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Company Email"
                                                      Placeholder="Email Id"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      InputType="InputType.Email"
                                                      @bind-Value="@_vendorReg.CompanyEmailID"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.CompanyEmailID)"
                                                      Disabled="@_isReadOnly"
                                                      For="@(() => _vendorReg.CompanyEmailID)"/>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Company Website"
                                                      Placeholder="Website"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.WebSite"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.WebSite)"
                                                      Disabled="@_isReadOnly"/>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>
                        <MudItem id="Address Details" md="4" Class="h-150">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">
                                <MudGrid Spacing="0" GutterSize="1" AlignItems="center">
                                    <MudText Typo="Typo.h6" Color="Color.Info">Address Details</MudText>
                                    <MudDivider Class="mx-2" />
                                    <MudItem xs="12">
                                        <MudTextField Label="Address Line 1"
                                                      Placeholder="Steet"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.RegAddress1"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.RegAddress1)"
                                                      Disabled="@_isReadOnly"/>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Address Line 2"
                                                      Placeholder="Area"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.RegAddress2"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.RegAddress2)"
                                                      Disabled="@_isReadOnly"
                                                      OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.RegAddress2)))" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Address Line 3"
                                                      Placeholder="Locality/Landmark"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.RegAddress3"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.RegAddress3)"
                                                      Disabled="@_isReadOnly"
                                                      OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.RegAddress3)))" />
                                    </MudItem>
                                    <MudItem xs="6" class="pe-1">
                                        <MudTextField Label="City"
                                                      Placeholder="City/Town"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.RegCity"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.RegCity)"
                                                      Disabled="@_isReadOnly"
                                                      OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.RegCity)))" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField Label="PIN Code"
                                                      Placeholder="Postal Code"
                                                      Typo="Typo.subtitle2"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.RegPIN"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.RegPIN)"
                                                      Disabled="@_isReadOnly"
                                                      OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.RegPIN)))" />
                                    </MudItem>
                                    <MudItem xs="6" class="pe-1">
                                        <MudTextField Label="State"
                                                      Placeholder="State"
                                                      Typo="Typo.subtitle2"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.RegState"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.RegState)"
                                                      Disabled="@_isReadOnly"
                                                      OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.RegState)))" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField Label="Country"
                                                      Placeholder="Country"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.RegCountry"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.RegCountry)"
                                                      Disabled="@_isReadOnly" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>
                        <!-- Responder Email -->
                        <MudItem md="4" Class="h-150">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">
                                <MudGrid Spacing="0" GutterSize="1" AlignItems="center">
                                    <MudText Typo="Typo.h6" Color="Color.Info">Responder's Information</MudText>
                                    <MudDivider Class="mx-2" />
                                    <MudItem xs="12">
                                        <MudTextField Label="First Name"
                                                      Placeholder="First Name"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.ResponderFName"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.ResponderFName)"
                                                      Disabled="@_isReadOnly" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Last Name"
                                                      Placeholder="Last Name"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.ResponderLName"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.ResponderLName)"
                                                      Disabled="@_isReadOnly" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Designation"
                                                      Placeholder="Responders Designation"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      @bind-Value="@_vendorReg.ResponderDesignation"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.ResponderDesignation)"
                                                      Disabled="@_isReadOnly"
                                                      For="@(() => _vendorReg.ResponderDesignation)" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Mobile"
                                                      Placeholder="Responders Mobile Number"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      InputType="InputType.Telephone"
                                                      Format="(##) #####-#####"
                                                      @bind-Value="@_vendorReg.ResponderMobileNo"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.ResponderMobileNo)"
                                                      Disabled="@_isReadOnly" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField Label="Email"
                                                      Placeholder="Responders Email ID"
                                                      Typo="@_inputTypo"
                                                      Variant="Variant.Text"
                                                      FullWidth="true"
                                                      Margin="Margin.Dense"
                                                      InputType="InputType.Email"
                                                      @bind-Value="@_vendorReg.ResponderEmailId"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.ResponderEmailId)"
                                                      Disabled="@_isReadOnly"
                                                      For="@(() => _vendorReg.ResponderEmailId)" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>

                    </MudGrid>

                </MudStep>


                <MudStep Title="Registration Details" Label="Step 2" Icon="@Icons.Material.Filled.Filter2" @bind-Completed="_completed" HasError=true>
                    <MudGrid GutterSize="1" Spacing="1">
                        <MudItem md="4">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">
                                <MudText Typo="Typo.h6" Color="Color.Info">Registration Details</MudText>
                                <MudDivider Class="mx-2" />
                                <MudGrid GutterSize="1" AlignItems="Center" Spacing="1">

                                    <!-- PAN field (takes most of the width) -->
                                    <MudItem xs="10" md="10" Style="padding-right:4px;">

                                        <MudTextField @bind-Value="_vendorReg.PANNo"
                                                      Placeholder="PAN Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="PAN No"
                                                      Margin="Margin.Dense"
                                                      Required="@_isPANrequired"
                                                      FullWidth="true"
                                                      Disabled="@_isReadOnly"
                                                      For="@(() => _vendorReg.PANNo)"
                                                      OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.PANNo)))" />
                                    </MudItem>

                                    <!-- Uploader (aligned to the right of the PAN field) -->
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="PAN"
                                                                 OnChange="OnPANUploaded"
                                                                 ImgUrl="@_vendorReg.PANCardURL"
                                                                 IsReadOnly="@_isPANRequired" />
                                    </MudItem>

                                    <!-- TAN -->
                                    <MudItem xs="10" md="10" Style="padding-right:4px ;">
                                        <MudTextField @bind-Value="_vendorReg.TANNo"
                                                      Placeholder="TAN Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="TAN No"
                                                      Margin="Margin.Dense"
                                                      Required="@_isTANRrequired"
                                                      FullWidth="true" />
                                    </MudItem>
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="TAN"
                                                                 OnChange="OnTANUploaded"
                                                                 ImgUrl="@_vendorReg.TANCertURL"
                                                                 IsRequired="@_isTANRrequired" />
                                    </MudItem>

                                    <!-- GST -->
                                    <MudItem xs="10" md="10" Style="padding-right:4px;">
                                        <MudTextField @bind-Value="_vendorReg.GSTNO"
                                                      Placeholder="GST Registration Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="GST No"
                                                      Margin="Margin.Dense"
                                                      Required="@_isGSTRequired"
                                                      FullWidth="true" />
                                    </MudItem>
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="GST"
                                                                 OnChange="OnGSTUploaded"
                                                                 ImgUrl="@_vendorReg.GSTRegistrationCertURL"
                                                                 IsRequired="@_isGSTRequired" />
                                    </MudItem>

                                    <!-- CIN -->
                                    <MudItem xs="10" md="10" Style="padding-right:4px;">
                                        <MudTextField @bind-Value="_vendorReg.CIN"
                                                      Placeholder="CIN Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="CIN"
                                                      Margin="Margin.Dense"
                                                      Required="@_isCINRequired"
                                                      FullWidth="true" />
                                    </MudItem>
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="CIN"
                                                                 OnChange="OnCINUploaded"
                                                                 ImgUrl="@_vendorReg.CINCertURL"
                                                                 IsRequired="@_isCINRequired" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>

                        <!-- Column for AADHAR / UDYAM / PF / ESI with uploader on the right of each field -->
                        <MudItem md="4">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">
                                <MudText Typo="Typo.h6" Color="Color.Info">Registration Details</MudText>
                                <MudDivider Class="mx-2" />
                                <MudGrid GutterSize="1" AlignItems="Center" Spacing="1">

                                    <MudItem xs="10" md="10" Style="padding-right:4px;">


                                        <MudTextField @bind-Value="_vendorReg.AadharNo"
                                                      Placeholder="AADHAR Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="Aadhar No"
                                                      Margin="Margin.Dense"
                                                      Required="@_IsAadharRequired"
                                                      FullWidth="true"
                                                      For="@(() => _vendorReg.AadharNo)"
                                                      OnBlur="@(async (e) => await ValidateField(nameof(_vendorReg.AadharNo)))" />
                                    </MudItem>
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="AADHAR"
                                                                 OnChange="OnAADHARUploaded"
                                                                 ImgUrl="@_vendorReg.AadharDocURL"
                                                                 IsRequired="@_IsAadharRequired" />
                                    </MudItem>

                                    <MudItem xs="10" md="10" Style="padding-right:4px;">
                                        <MudTextField @bind-Value="_vendorReg.UDYAMRegNo"
                                                      Placeholder="UDYAM Registration Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="UDYAM No"
                                                      Margin="Margin.Dense"
                                                      Required="@_isUDYAMRequired"
                                                      FullWidth="true" />
                                    </MudItem>
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="AADHAR"
                                                                 OnChange="OnUDYAMUploaded"
                                                                 ImgUrl="@_vendorReg.UDYAMRegCertURL"
                                                                 IsRequired="@_IsAadharRequired" />
                                    </MudItem>



                                    <MudItem xs="10" md="10" Style="padding-right:4px;">
                                        <MudTextField @bind-Value="_vendorReg.PFNo"
                                                      Placeholder="PF Registration Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="PF Reg No"
                                                      Margin="Margin.Dense"
                                                      Required="@_isPFRequired"
                                                      FullWidth="true" />
                                    </MudItem>
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="PF"
                                                                 OnChange="OnPFUploaded"
                                                                 ImgUrl="@_vendorReg.PFRegCertURL"
                                                                 IsRequired="@_isPFRequired" />
                                    </MudItem>

                                    <MudItem xs="10" md="10" Style="padding-right:4px;">
                                        <MudTextField @bind-Value="_vendorReg.ESIRegNo"
                                                      Placeholder="ESI Registration Number"
                                                      Typo="Typo.subtitle2"
                                                      Label="ESI Reg No"
                                                      Margin="Margin.Dense"
                                                      Required="@_isESIRequired"
                                                      FullWidth="true" />
                                    </MudItem>
                                    <MudItem xs="2" md="2" Style="display:flex; align-items:center; justify-content:center; padding-left:0;">
                                        <OrgRegisterDocsUploader DocType="ESI"
                                                                 OnChange="OnESIUploaded"
                                                                 ImgUrl="@_vendorReg.ESIRegCertURL"
                                                                 IsRequired="@_isESIRequired" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>

                        <MudItem md="4">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">
                                <MudText Typo="Typo.h6" Color="Color.Info">Bank Account Details</MudText>
                                <MudDivider Class="mx-2" />

                                <MudGrid GutterSize="1" AlignItems="Center" Spacing="1">
                                    <MudItem xs="12" md="12" Style="padding-right:4px;">
                                        <MudTextField @bind-Value="_vendorReg.BankName"
                                                      Placeholder="Name of the Bank"
                                                      Typo="Typo.subtitle2"
                                                      Label="Bank Name"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.BankName)"
                                                      Style="flex:1;" />
                                        <MudTextField @bind-Value="_vendorReg.BankBranch"
                                                      Placeholder="Name of the Bank Branch"
                                                      Typo="Typo.subtitle2"
                                                      Label="Bank Branch"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.BankBranch)"
                                                      Style="flex:1;" />
                                        <MudTextField @bind-Value="_vendorReg.IFSCCode"
                                                      Placeholder="IFSC Code"
                                                      Typo="Typo.subtitle2"
                                                      Label="IFSC Code"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.IFSCCode)"
                                                      Style="flex:1;" />
                                        <MudTextField @bind-Value="_vendorReg.AccountNumber"
                                                      Label="Account Number"
                                                      Placeholder="Account Number"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.AccountNumber)"
                                                      Style="flex:1;" />
                                        <MudTextField @bind-Value="_vendorReg.AccountName"
                                                      Label="Account Name"
                                                      Placeholder="Name of the Account Holder/Organizaton"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.AccountName)"
                                                      Style="flex:1;" />
                                        <MudText Typo="Typo.caption" Color="Color.Primary" Style="flex:1;">Upload a Cancelled Cheq/Bank Statement </MudText>
                                        <OrgRegisterDocsUploader DocType="CANCELCHEQ" OnChange="OnCancelCheqUploaded" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>

                    </MudGrid>
                </MudStep>


                <MudStep Title="Project Reference" Label="Step 3" Icon="@Icons.Material.Filled.Filter3">
                    <MudGrid GutterSize="1" AlignItems="Center" Spacing="1" Class="mb-2">
                        <MudItem xs="6">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">
                                <MudText Typo="Typo.h6" Color="Color.Info">Project 1 </MudText>
                                <MudDivider Class="mx-2" />
                                <MudGrid GutterSize="1" AlignItems="Center" Spacing="1">
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_vendorReg.Experience1Customer"
                                                      Label="Customer Name"
                                                      Placeholder="Name of the Customeer"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience1Customer)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField @bind-Value="_vendorReg.Experience1Project"
                                                      Label="Project Name"
                                                      Placeholder="Name of the Project"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience1Project)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField @bind-Value="_vendorReg.Experience1City"
                                                      Label="City"
                                                      Placeholder="City where the Projet was done"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience1City)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField @bind-Value="_vendorReg.Experience1ProjectCost"
                                                      Label="Project Cost"
                                                      Placeholder="Approximate Cost"
                                                      Typo="Typo.subtitle2"
                                                      InputType="InputType.Number"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience1ProjectCost)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudSelect @bind-Value="_vendorReg.Experience1ProjectStatus"
                                                   Label="Project Status"
                                                   Placeholder="Current Status of Project"
                                                   Typo="Typo.subtitle2"
                                                   Margin="Margin.Dense"
                                                   Disabled="@_isReadOnly"
                                                   Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience1ProjectStatus)"
                                                   Style="flex:1;">
                                            <MudSelectItem Value="@("Completed")">Completed</MudSelectItem>
                                            <MudSelectItem Value="@("In Progress")">In Progress</MudSelectItem>
                                            <MudSelectItem Value="@("Cancelled")">Not Started</MudSelectItem>
                                            <MudSelectItem Value="@("Not Started")">Not Started</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudDatePicker @bind-date="_vendorReg.Experience1ProjectStartDt"
                                                       Label="Project Start Date"
                                                       Margin="Margin.Dense"
                                                       Disabled="@_isReadOnly"
                                                       Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience1ProjectStartDt)"
                                                       Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudDatePicker @bind-date="_vendorReg.Experience1ProjectEndDt"
                                                       Label="Project End Date"
                                                       Margin="Margin.Dense"
                                                       Disabled="@_isReadOnly"
                                                       Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience1ProjectEndDt)"
                                                       Style="flex:1;" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Height="100%" Elevation="1" Class="pa-2 h-150" Style="border:1px solid var(--mud-palette-lines-default); border-radius:6px;">

                                <MudText Typo="Typo.h6" Color="Color.Info">Project 2 </MudText>
                                <MudDivider Class="mx-2" />
                                <MudGrid GutterSize="1" AlignItems="Center" Spacing="1">
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_vendorReg.Experience2Customer"
                                                      Label="Customer Name"
                                                      Placeholder="Name of the Customeer"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience2Customer)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField @bind-Value="_vendorReg.Experience2Project"
                                                      Label="Project Name"
                                                      Placeholder="Name of the Project"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience2Project)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField @bind-Value="_vendorReg.Experience2City"
                                                      Label="City"
                                                      Placeholder="City where the Projet was done"
                                                      Typo="Typo.subtitle2"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience2City)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudTextField @bind-Value="_vendorReg.Experience2ProjectCost"
                                                      Label="Project Cost"
                                                      Placeholder="Approximate Cost"
                                                      Typo="Typo.subtitle2"
                                                      InputType="InputType.Number"
                                                      Margin="Margin.Dense"
                                                      Disabled="@_isReadOnly"
                                                      Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience2ProjectCost)"
                                                      Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudSelect @bind-Value="_vendorReg.Experience2ProjectStatus"
                                                   Label="Project Status"
                                                   Placeholder="Current Status of Project"
                                                   Typo="Typo.subtitle2"
                                                   Margin="Margin.Dense"
                                                   Disabled="@_isReadOnly"
                                                   Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience2ProjectStatus)"
                                                   Style="flex:1;">
                                            <MudSelectItem Value="@("Completed")">Completed</MudSelectItem>
                                            <MudSelectItem Value="@("In Progress")">In Progress</MudSelectItem>
                                            <MudSelectItem Value="@("Cancelled")">Not Started</MudSelectItem>
                                            <MudSelectItem Value="@("Not Started")">Not Started</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudDatePicker @bind-date="_vendorReg.Experience2ProjectStartDt"
                                                       Label="Project Start Date"
                                                       Margin="Margin.Dense"
                                                       Disabled="@_isReadOnly"
                                                       Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience2ProjectStartDt)"
                                                       Style="flex:1;" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudDatePicker @bind-date="_vendorReg.Experience2ProjectEndDt"
                                                       Label="Project End Date"
                                                       Margin="Margin.Dense"
                                                       Disabled="@_isReadOnly"
                                                       Required="@ValidationExtensions.HasRequiredAttribute(() => _vendorReg.Experience2ProjectEndDt)"
                                                       Style="flex:1;" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>



                </MudStep>

                <MudStep Title="Approvals" Label="Step 4" Icon="@Icons.Material.Filled.Filter4">
                    <MudGrid GutterSize="1" AlignItems="Center">
                        <MudItem xs="6" md="6">
                            <MudPaper Elevation="2" Class="pa-2">

                                <MudGrid Spacing="1" GutterSize="1" AlignItems="Center">
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.h6" Color="Color.Info">Reviewer Status</MudText>
                                    </MudItem>

                                    <MudItem xs="12">
                                        <MudDivider Class="my-2" />
                                    </MudItem>

                                    <MudItem xs="8">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Default">Reviewer</MudText>
                                        <MudText Typo="Typo.h6" Color="Color.Info">@(_vendorReg?.ReviewerName ?? "-")</MudText>
                                    </MudItem>

                                    <MudItem xs="4">
                                        <MudText Typo="Typo.body2">Reviewed On</MudText>
                                        <MudText Typo="Typo.h6" Color="Color.Info">
                                            @(_vendorReg?.ReviewDate is DateTime rd ? rd.ToString("dd-MMM-yyyy") : "—")
                                        </MudText>
                                    </MudItem>

                                    <MudItem xs="12" md="12">
                                        <MudText Typo="Typo.body2">Review Status</MudText>

                                        <MudSelect Label="Review Status"
                                                   Value="_vendorReg.ReviewerStatus"
                                                   ValueChanged="@(EventCallback.Factory.Create<string?>(this, OnReviewerStatusChanged))"
                                                   Variant="Variant.Text"
                                                   Margin="Margin.Dense"
                                                   Class="short-field"
                                                   Disabled="@_isReviewLocked">
                                            <MudSelectItem Value="@("Approved")">Approved</MudSelectItem>
                                            <MudSelectItem Value="@("Rejected")">Rejected</MudSelectItem>
                                            <MudSelectItem Value="@("Pending")">Pending</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>

                                    <MudItem xs="12" md="12">
                                        <MudText Typo="Typo.body2">Review Comments</MudText>
                                        <MudTextField Typo="Typo.subtitle2"
                                                      @bind-Value="_vendorReg.ReviewComments" />
                                    </MudItem>

                                    <MudItem xs="12" Class="d-flex justify-end">
                                        <MudButton ButtonType="ButtonType.Button"
                                                   Variant="Variant.Filled" Color="Color.Primary"
                                                   Disabled="@_isReviewLocked"
                                                   OnClick="LockReview">
                                            <MudText Typo="Typo.caption">Submit Review</MudText>
                                        </MudButton>
                                    </MudItem>
                                </MudGrid>

                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6" md="6">
                            <MudPaper Elevation="2" Class="pa-2">
                                <MudGrid Spacing="1" GutterSize="1" AlignItems="Center">
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.h6" Color="Color.Info">Approval Status</MudText>
                                    </MudItem>

                                    <MudItem xs="12">
                                        <MudDivider Class="my-2" />
                                    </MudItem>

                                    <!-- These two items are now direct children of a MudGrid so they render as two columns side-by-side -->
                                    <MudItem xs="8">
                                        <MudText Typo="Typo.subtitle2" Color="Color.Default">Approver</MudText>
                                        <MudText Typo="Typo.h6" Color="Color.Info">@(_vendorReg?.ApproverName ?? "-")</MudText>
                                    </MudItem>

                                    <MudItem xs="4">
                                        <MudText Typo="Typo.body2">Approved On</MudText>
                                        <MudText Typo="Typo.h6" Color="Color.Info">
                                            @(_vendorReg?.ApprovalDate is DateTime rd ? rd.ToString("dd-MMM-yyyy") : "—")
                                        </MudText>
                                    </MudItem>

                                    <MudItem xs="12" md="12">
                                        <MudText Typo="Typo.body2">Approval Status</MudText>

                                        <MudSelect Label="Approval Status"
                                                   Value="_vendorReg.ApproverStatus"
                                                   ValueChanged="@(EventCallback.Factory.Create<string?>(this, OnApproverStatusChanged))"
                                                   Variant="Variant.Text"
                                                   Margin="Margin.Dense"
                                                   Class="short-field"
                                                   Disabled="@_isApproverLocked">
                                            <MudSelectItem Value="@("Approved")">Approved</MudSelectItem>
                                            <MudSelectItem Value="@("Rejected")">Rejected</MudSelectItem>
                                            <MudSelectItem Value="@("Pending")">Pending</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>

                                    <MudItem xs="12" md="12">
                                        <MudText Typo="Typo.body2">Approval Comments</MudText>
                                        <MudTextField Typo="Typo.subtitle1" @bind-Value="_vendorReg.ApprovalComments" />
                                    </MudItem>

                                    <MudItem xs="12" Class="d-flex justify-end">
                                        <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled"
                                                   Color="Color.Primary"
                                                   Disabled="@_isApproverLocked"
                                                   OnClick="LockApproval">
                                            <MudText Typo="Typo.caption">Submit Approval</MudText>
                                        </MudButton>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                </MudStep>


            </MudStepper>

            <MudDivider Class="my-2" />
            <div class="d-flex justify-end mt-2">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           OnClick="OnCancel"
                           Disabled="@_isSaving"
                           Class="me-2">
                    Cancel
                </MudButton>

                <!-- Submit as form submit so EditForm runs HandleSubmit -->
                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Medium" Class="me-2" Indeterminate="true" />
                        <span>Saving…</span>
                    }
                    else
                    {
                        <span>Submit</span>
                    }
                </MudButton>
            </div>
        </EditForm>
    </MudCardContent>
</MudCard>

@code {
    private List<BreadcrumbItem> _items = new()
    {
        new BreadcrumbItem("Home", href: "/", disabled: false),
        new BreadcrumbItem("Registration List", href: "/vendor-registrations", disabled: false),
    };

    private Typo _inputTypo = Typo.caption;
    // Add a property to convert between enum and string for binding
    private string? _reviewStatusString
    {
        get => _vendorReg.ReviewStatus?.ToString();
        set
        {
            if (Enum.TryParse<Entities.Models.VendorReg.ReviewStatus>(value, out var result))
                _vendorReg.ReviewStatus = result;
            else
                _vendorReg.ReviewStatus = null;
        }
    }

    private void OnReviewStatusChanged(string? value)
    {
        _reviewStatusString = value;
        StateHasChanged();
    }
}
