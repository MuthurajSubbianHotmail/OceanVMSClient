@page "/vendor-registrations"
@using Shared.DTO
@using Shared.DTO.VendorReg
@using MudBlazor.Components
@inject NavigationManager NavigationManager

<MudBreadcrumbs Items="_items" Separator="/" Class="mb-0" />
<PageHeader Title="Vendor Registrations" Class="mb-0" />

<MudPaper Class="pa-4 vendorreg-paper">
    <MudPaper Elevation="1" Class="mt-2 px-2" >
        <MudGrid GutterSize="2" AlignItems="AlignItems.Center">
            <MudItem xs="12">
                <MudGrid GutterSize="1">
                    
                        <MudItem xs="12" sm="2">
                            <MudTextField T="string"
                                          Label="Organization"
                                          Placeholder="Organization"
                                          Typo="Typo.caption"
                                          @bind-Value="organizationName"
                                          DebounceInterval="300"
                                          OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                          Dense="true" Class="filter-control" />
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudTextField T="string"
                                          Label="Organization"
                                          Placeholder="Organization"
                                          Typo="Typo.caption"
                                          @bind-Value="organizationName"
                                          DebounceInterval="300"
                                          OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                          Dense="true" Class="filter-control" />
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudTextField T="string" Label="Responder Name"
                                          Placeholder="Responder Name"
                                          Typo="Typo.caption"
                                          @bind-Value="responderFullName"
                                          DebounceInterval="300"
                                          OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                          Dense="true" Class="filter-control" />
                        </MudItem>

                        <MudItem xs="12" sm="2">
                            <MudTextField T="string" Label="GST No" Placeholder="GST No"
                                          Typo="Typo.caption"
                                          @bind-Value="gstno"
                                          DebounceInterval="300"
                                          OnDebounceIntervalElapsed="@( (string s) => OnSearch() )"
                                          Dense="true" Class="filter-control" />
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudSelect T="string"
                                       Label="Review Status"
                                       Placeholder="Review Status"
                                       Dense="true"
                                       Typo="Typo.caption"
                                       ValueChanged="@(EventCallback.Factory.Create<string?>(this, OnReviewerStatusChanged))">
                                <MudSelectItem T="string" Value="@("All")">All</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Pending")">Pending</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Approved")">Approved</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Rejected")">Rejected</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudSelect T="string"
                                       Label="Approval Status"
                                       Placeholder="Approval Status"
                                       Dense="true"
                                       Typo="Typo.caption"
                                       ValueChanged="@(EventCallback.Factory.Create<string?>(this, OnApproverStatusChanged))">
                                <MudSelectItem T="string" Value="@("All")">All</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Pending")">Pending</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Approved")">Approved</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Rejected")">Rejected</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    
                </MudGrid>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable T="VendorRegistrationFormDto"
              ServerData="GetServerData"
              Hover="true"
              Dense="true"
              Breakpoint="Breakpoint.Sm"
              @ref="_table"
              RowsPerPage="15"
              Height="400px"
              Class="vendorreg-table mt-3">
        <HeaderContent>
            <MudTh Class="style: width:20%">Organization</MudTh>
            <MudTh Class="style: width:10%">GST No</MudTh>
            <MudTh Class="style: width:10%">Services</MudTh>
            <MudTh Class="style: width:10%">Responder</MudTh>
            <MudTh Class="style: width:20%">Registr.Date</MudTh>
            <MudTh Class="style: width:10%">City</MudTh>
            <MudTh Class="style: width:10%">Review Status</MudTh>
            <MudTh Class="style: width:10%">Approval Status</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>
                <MudLink Href="@($"/register-vendor/{context.Id}")">
                    @context.OrganizationName
                </MudLink>
            </MudTd>
            <MudTd>@context.GSTNO</MudTd>
            <MudTd>@context.VendorServices</MudTd>

            <MudTd>@($"{context.ResponderFName} {context.ResponderLName}")</MudTd>
            <MudTd>@(context.RegistrationDate == default ? "—" : context.RegistrationDate.ToString("dd-MMM-yy"))</MudTd>

            <MudTd>@context.RegCity</MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetReviewStatusColor(context.ReviewerStatus)" Variant="Variant.Filled">
                    @context.ReviewerStatus
                </MudChip>
            </MudTd>
            <MudTd>
                <MudChip T="string" Size="Size.Small" Color="@GetReviewStatusColor(context.ApproverStatus)" Variant="Variant.Filled">
                    @context.ApproverStatus
                </MudChip>
            </MudTd>
            <MudTd>
                @* <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                           OnClick="@(() => NavigationManager.NavigateTo($"/register-vendor/{context.Id}"))">
                    View
                </MudButton> *@
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager PageSizeOptions="@_pageSizeOption" RowsPerPageString="Registrations Per Page" />
        </PagerContent>
    </MudTable>
    <MudDivider Class="mt-2"/>
    <MudItem xs="12" Class="d-flex justify-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ExportVisibleToCsv">
            Export CSV
        </MudButton>
    </MudItem>
</MudPaper>

@code {
    // Existing fields and methods...

    private Color GetReviewStatusColor(string reviewStatus)
    {
        return reviewStatus switch
        {
            "Pending" => Color.Warning,
            "Reviewed" => Color.Info,
            "Rejected" => Color.Error,
            "Approved" => Color.Success,
            _ => Color.Default
        };
    }

    // If you also need GetApprovalStatusColor, ensure it's defined similarly.

    private async Task OnApproverStatusChanged(string value)
    {
        approverStatus = value;
        await OnSearch();
    }

    private async Task OnReviewerStatusChanged(string value)
    {
        reviewerStatus = value;
        await OnSearch();
    }
}
