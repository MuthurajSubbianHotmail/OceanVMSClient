<?xml version="1.0" encoding="utf-8"?>
<configuration>
	<system.webServer>
		<!-- SPA fallback: rewrite unknown routes to index.html -->
		<rewrite>
			<rules>
				<rule name="SPA fallback" stopProcessing="true">
					<match url=".*" />
					<conditions>
						<add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
						<add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
						<add input="{REQUEST_URI}" pattern="^/api" negate="true" />
					</conditions>
					<action type="Rewrite" url="/index.html" />
				</rule>
			</rules>

			<!-- PreCondition definitions required when rules reference preCondition="Always" -->
			<outboundRules>
				<preConditions>
					<!-- "Always" preCondition: matches any response (keeps examples simple).
               You can tighten this later (e.g. only for certain Content-Type values). -->
					<preCondition name="Always">
						<add input="{RESPONSE_Content-Type}" pattern=".*" />
					</preCondition>
				</preConditions>

				<!-- Outbound rule: force no-cache headers for critical non-hashed files -->
				<rule name="NoCacheForBootAndSW" preCondition="Always">
					<match serverVariable="RESPONSE_Cache-Control" pattern=".*" />
					<conditions>
						<add input="{REQUEST_URI}" pattern="(index\.html|service-worker\.js|service-worker\.published\.js|service-worker-assets\.js|blazor\.boot\.json|_framework/blazor\.boot\.json|version\.json|manifest\.webmanifest)$" ignoreCase="true" />
					</conditions>
					<action type="Rewrite" value="no-cache, no-store, must-revalidate" />
				</rule>
			</outboundRules>
		</rewrite>

		<!-- Default long cache for static hashed assets -->
		<staticContent>
			<clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="365.00:00:00" />
		</staticContent>
	</system.webServer>

	<!-- Disable caching for files that must be revalidated after deploy -->
	<location path="index.html">
		<system.webServer>
			<staticContent>
				<clientCache cacheControlMode="DisableCache" />
			</staticContent>
		</system.webServer>
	</location>

	<location path="service-worker.js">
		<system.webServer>
			<staticContent>
				<clientCache cacheControlMode="DisableCache" />
			</staticContent>
		</system.webServer>
	</location>

	<location path="service-worker.published.js">
		<system.webServer>
			<staticContent>
				<clientCache cacheControlMode="DisableCache" />
			</staticContent>
		</system.webServer>
	</location>

	<location path="service-worker-assets.js">
		<system.webServer>
			<staticContent>
				<clientCache cacheControlMode="DisableCache" />
			</staticContent>
		</system.webServer>
	</location>

	<location path="version.json">
		<system.webServer>
			<staticContent>
				<clientCache cacheControlMode="DisableCache" />
			</staticContent>
		</system.webServer>
	</location>

	<location path="manifest.webmanifest">
		<system.webServer>
			<staticContent>
				<clientCache cacheControlMode="DisableCache" />
			</staticContent>
		</system.webServer>
	</location>

	<!-- For the Blazor boot file under _framework -->
	<location path="_framework/blazor.boot.json">
		<system.webServer>
			<staticContent>
				<clientCache cacheControlMode="DisableCache" />
			</staticContent>
		</system.webServer>
	</location>
</configuration>