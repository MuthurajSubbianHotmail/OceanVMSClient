@using System.Security.Claims

<MudDrawer Class="nav-drawer" @bind-Open="SideBarOpen" ClipMode="DrawerClipMode.Never" Elevation="1" Variant="DrawerVariant.Temporary">
    <MudDrawerHeader Class="nav-drawer-header">
        <MudImage Style="height: 34px; width: auto;" Src="/assets/logo-web.png" />
    </MudDrawerHeader>

    <MudNavMenu Class="nav-menu">
        <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>

        <MudNavGroup Title="Purchase Order" Icon="@Icons.Material.Filled.Inventory" Expanded="false">
            <AuthorizeView Roles="EMPLOYEE">
                <Authorized>
                    <MudNavLink Href="po-list" Icon="@Icons.Material.Filled.ShoppingCart">Company</MudNavLink>
                </Authorized>
            </AuthorizeView>
            <MudNavLink Href="polist" Icon="@Icons.Material.Filled.Assignment">PO List</MudNavLink>
        </MudNavGroup>

        <MudNavGroup Title="Invoices" Icon="@Icons.Material.Filled.AutoAwesomeMosaic" Expanded="false">
            <AuthorizeView Roles="EMPLOYEE, VENDOR">
                <Authorized>
                    <MudNavLink Href="invoices" Icon="@Icons.Material.Filled.ReceiptLong">Invoice List</MudNavLink>
                </Authorized>
            </AuthorizeView>
            <MudNavLink Href="invoices" Icon="@Icons.Material.Filled.ReceiptLong">Invoice List</MudNavLink>
        </MudNavGroup>

        <MudNavGroup Title="Vendors" Icon="@Icons.Material.Filled.Person" Expanded="false">
            <AuthorizeView Context="auth">
                <Authorized>
                    @if (UserHasVendorReviewRole(auth.User))
                    {
                        <MudNavLink Href="vendor-registrations" Icon="@Icons.Material.Filled.ListAlt">Vendor Registrations</MudNavLink>
                    }
                </Authorized>
            </AuthorizeView>

            @* <MudNavLink Href=@($"register-vendor/{Guid.Empty}") Icon="@Icons.Material.Filled.AppRegistration">New Vendor Registration</MudNavLink> *@
            <AuthorizeView Context="auth">
                <Authorized>
                    @if (UserHasVendorRole(auth.User))
                    {
                        <MudNavLink Href="VendorProfile" Icon="@Icons.Material.Filled.Person2">Vendor Profile</MudNavLink>
                    }
                </Authorized>
            </AuthorizeView>
            
        </MudNavGroup>
       
    </MudNavMenu>
</MudDrawer>

@code {
    [Parameter]
    public bool SideBarOpen { get; set; }

    private static bool UserHasVendorReviewRole(ClaimsPrincipal? user)
    {
        if (user?.Identity?.IsAuthenticated != true) return false;

        // Collect all role-like claim values (handles ClaimTypes.Role, "role"/"roles", "/role", arrays and comma lists)
        var roleValues = user.Claims
            .Where(c =>
                string.Equals(c.Type, ClaimTypes.Role, StringComparison.OrdinalIgnoreCase)
                || c.Type.EndsWith("/role", StringComparison.OrdinalIgnoreCase)
                || string.Equals(c.Type, "role", StringComparison.OrdinalIgnoreCase)
                || string.Equals(c.Type, "roles", StringComparison.OrdinalIgnoreCase)
                || c.Type.EndsWith("/roles", StringComparison.OrdinalIgnoreCase))
            .SelectMany(c => SplitRoleClaimValue(c.Value))
            .Select(r => r.Trim().Trim('"', '\''))
            .Where(r => !string.IsNullOrEmpty(r))
            .Select(r => r.ToUpperInvariant());

        return roleValues.Any(r => r == "VENDOR VALIDATOR" || r == "VENDOR APPROVER");
    }

    private static bool UserHasVendorRole(ClaimsPrincipal? user)
    {
        if (user?.Identity?.IsAuthenticated != true) return false;

        // Collect all role-like claim values (handles ClaimTypes.Role, "role"/"roles", "/role", arrays and comma lists)
        var roleValues = user.Claims
            .Where(c =>
                string.Equals(c.Type, ClaimTypes.Role, StringComparison.OrdinalIgnoreCase)
                || c.Type.EndsWith("/role", StringComparison.OrdinalIgnoreCase)
                || string.Equals(c.Type, "role", StringComparison.OrdinalIgnoreCase)
                || string.Equals(c.Type, "roles", StringComparison.OrdinalIgnoreCase)
                || c.Type.EndsWith("/roles", StringComparison.OrdinalIgnoreCase))
            .SelectMany(c => SplitRoleClaimValue(c.Value))
            .Select(r => r.Trim().Trim('"', '\''))
            .Where(r => !string.IsNullOrEmpty(r))
            .Select(r => r.ToUpperInvariant())
            .ToList();

        // Only show the vendor menu when the user's role set indicates a plain "VENDOR" role
        // and does NOT include approver/reviewer/validator roles.
        var hasVendor = roleValues.Any(r => r == "VENDOR");
        var hasApproverOrReviewer = roleValues.Any(r => r.Contains("APPROVER") || r.Contains("VALIDATOR") || r.Contains("REVIEWER"));

        return hasVendor && !hasApproverOrReviewer;
    }
    private static IEnumerable<string> SplitRoleClaimValue(string? value)
    {
        if (string.IsNullOrWhiteSpace(value)) yield break;

        // If value looks like a JSON array (["a","b"]) try a simple trim first.
        var s = value.Trim();
        if (s.StartsWith("[") && s.EndsWith("]"))
        {
            s = s.Trim('[', ']', '"', '\'');
        }

        foreach (var part in s.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries))
            yield return part;
    }
}