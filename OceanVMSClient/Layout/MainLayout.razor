@inherits LayoutComponentBase
@using OceanVMSClient.Components
@using MudBlazor
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<!-- Layout container: make a column flex so footer sits after content or at viewport bottom when content is short -->
<div style="display:flex; flex-direction:column; min-height:100vh;">
    <MudLayout style="flex:1;">
        <MudAppBar Elevation="3" Dense="true">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleSidebar"/> 

            <!-- Company caption placed in the app bar (uses .app-bar-caption to apply the specific font only here) -->
            <MudText Typo="Typo.body2" Color="Color.Inherit" Class="app-bar-caption">
                Ocean Lifespaces India Private Limited - Vendor Management Portal
            </MudText>

            <MudSpacer />
            <div style="display:inline-flex; align-items:center; gap:8px;">
                <AuthLinkDiv />
               
            </div>
            @if (_isDarkMode)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Brightness5" Color="Color.Inherit" OnClick="@ToggleTheme" />
            }
            else
            {
                <MudIconButton Icon="@Icons.Material.Filled.Brightness4" Color="Color.Inherit" OnClick="@ToggleTheme" />
            }
        </MudAppBar>

        <!-- NavMenu moved out of the AppBar so it renders below the AppBar and cannot overlap it -->
        <div style="width:100%;">
            <NavMenu SideBarOpen="_sidebarOpen" />
        </div>
        
        <MudMainContent Class="pt-8 px-16">
            <MudContainer Class="mt-6">
                
                <MudPopoverProvider />
                <!-- keep VersionChecker active for polling/notifications but hide its inline footer -->
                <VersionChecker ShowFooter="false" />
                <UpdateNotification />
                @Body
            </MudContainer>
        </MudMainContent>
    </MudLayout>

    <!-- footer placed after layout so it participates in document flow.
         Use MudBlazor theme CSS variables for background but force white text color. -->
    <footer role="contentinfo" aria-label="Application footer" style="width:100%;">
        <div style="background-color:var(--mud-palette-primary); color:white; width:100%; display:flex; justify-content:space-between; align-items:center; padding:8px 16px; font-size:0.575rem;">
            
            <div>
                Powered By: Crisolite Solutions 2026
            </div>
            <div>
                @if (!string.IsNullOrWhiteSpace(_appVersion))
                {
                    <span>v@_appVersion</span>
                }
            </div>
            <div>
                <!-- One-click update action visible to users -->
                <ForceUpdate />
            </div>
        </div>
    </footer>
</div>

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode"/>
<MudSnackbarProvider />
<MudDialogProvider Position="DialogPosition.Center" CloseButton="true" BackdropClick="false"/>
@code {
    MudTheme MyCustomTheme = new MudTheme()
    {
        Typography = new Typography()
        {
            Body2 = new Body2Typography()
            {
                FontFamily = new[] { "Roboto", "Helvetica", "Arial", "sans-serif" },
                FontSize = "0.5rem",
                FontWeight = "100",
                LineHeight = "1",
                LetterSpacing = ".0075em"
            }
        }
    };

    private bool _sidebarOpen = false;
    private void ToggleSidebar() => _sidebarOpen = !_sidebarOpen;
    
    private bool _isDarkMode;
    private void ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        if (!_isDarkMode)
        {
            _isDarkMode = false;
        }
        else
        {
            _isDarkMode = true;
        }
    }
    bool _drawerOpen = true;

    private string? _appVersion;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Build absolute URL to avoid base-address mismatch and to handle 404 gracefully
            var uri = $"{NavigationManager.BaseUri.TrimEnd('/')}/version.json?cb={DateTime.UtcNow.Ticks}";
            using var response = await Http.GetAsync(uri);

            if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                _appVersion = null;
            }
            else
            {
                response.EnsureSuccessStatusCode();
                var json = await response.Content.ReadAsStringAsync();

                using var doc = System.Text.Json.JsonDocument.Parse(json);
                // prefer 'appVersion' key, fall back to 'version'
                if (doc.RootElement.TryGetProperty("appVersion", out var appVer) && appVer.ValueKind == System.Text.Json.JsonValueKind.String)
                    _appVersion = appVer.GetString();
                else if (doc.RootElement.TryGetProperty("version", out var ver) && ver.ValueKind == System.Text.Json.JsonValueKind.String)
                    _appVersion = ver.GetString();
            }
        }
        catch
        {
            // ignore errors reading version (keep UI clean)
            _appVersion = null;
        }

        // check if we were reloaded due to a version update
        try
        {
            var reloadedVersion = await JS.InvokeAsync<string>("localStorage.getItem", "app.reloadedForVersion");
            if (!string.IsNullOrWhiteSpace(reloadedVersion))
            {
                Snackbar.Add($"Application reloaded to version {reloadedVersion}", Severity.Success);
                await JS.InvokeVoidAsync("localStorage.removeItem", "app.reloadedForVersion");
            }
        }
        catch
        {
            // ignore JS/localStorage errors
        }
    }
}