@using System.Security.Claims
@using System.Linq
@using System.Text.Json
@using System.Globalization
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@using MudBlazor

<AuthorizeView Context="auth">
    <Authorized>
        @{
            var user = auth.User;
            var given = user.FindFirst(ClaimTypes.GivenName)?.Value;
            var family = user.FindFirst(ClaimTypes.Surname)?.Value;
            var nameClaim = user.FindFirst(ClaimTypes.Name)?.Value;
            var emailClaim = user.FindFirst(ClaimTypes.Email)?.Value;
            // roles can be multiple ClaimTypes.Role or a single claim containing array/csv
            var roles = user.FindAll(ClaimTypes.Role).Select(c => c.Value).ToList();
            if (!roles.Any())
            {
                var rolesClaim = user.FindFirst("roles")?.Value ?? user.FindFirst("RoleNames")?.Value;
                if (!string.IsNullOrWhiteSpace(rolesClaim))
                {
                    try
                    {
                        var arr = JsonSerializer.Deserialize<string[]>(rolesClaim);
                        if (arr != null) roles.AddRange(arr);
                    }
                    catch
                    {
                        roles.AddRange(rolesClaim.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()));
                    }
                }
            }
            var userType = user.FindFirst("UserType")?.Value ?? user.FindFirst("userType")?.Value;
            string fullName = BuildFullName(given, family, nameClaim);
        }

        <MudText Style="cursor:pointer; font-weight:500;" OnClick="@TogglePanel">@fullName</MudText>
        @if (!string.IsNullOrWhiteSpace(userType))
        {
            <span>&nbsp;|&nbsp;@FormatStringType(userType)</span>
        }
         <MudLink Href="Logout" Style="margin-left:.5rem;" Color="Color.Inherit">Log Out</MudLink>

        @if (isPanelOpen)
        {
            <div class="auth-details-panel"
                 style="position:absolute; right:1rem; top:3.25rem;
                            background:var(--mud-palette-surface, #ffffff);
                            color:var(--mud-palette-text-primary, #000000);
                            border:1px solid rgba(0,0,0,.12);
                            padding:.5rem .75rem;
                            border-radius:.25rem;
                            box-shadow:0 6px 18px rgba(0,0,0,.15);
                            z-index:2000;
                            min-width:250px;">
                <button @onclick="ClosePanel"
                        title="Close"
                        aria-label="Close"
                        style="position:absolute; top:4px; right:6px; background:transparent; border:0; color:var(--mud-palette-text-primary,#000); font-size:16px; line-height:1; cursor:pointer;">
                    &times;
                </button>

                <div style="margin-bottom:.375rem;"><strong>Name:</strong> @fullName</div>
                @if (!string.IsNullOrWhiteSpace(userType))
                {
                    <div style="margin-bottom:.25rem;"><strong>Type:</strong> @FormatStringType(userType)</div>
                }
                @if (!string.IsNullOrWhiteSpace(emailClaim))
                {
                    <div style="margin-bottom:.25rem;"><strong>Email:</strong> @emailClaim</div>
                }
                @if (roles.Any())
                {
                    <div style="margin-bottom:.5rem;"><strong>Roles:</strong> @string.Join(", ", roles.Select(r => FormatStringType(r)))</div>
                }

                <hr style="margin:.25rem 0; border:0; border-top:1px solid rgba(0,0,0,.08)" />

                <div style="display:flex; flex-direction:column; gap:.25rem;">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NavigateToChangePassword" Style="padding:0; text-align:left;">
                        Change Password
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="NavigateToLogout" Style="padding:0; text-align:left;">
                        Log Out
                    </MudButton>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <MudLink Href="Login" Color="Color.Inherit">LogIn</MudLink>
        &nbsp;&nbsp;
        <MudLink Href="Registration" Color="Color.Inherit">Register</MudLink>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool isPanelOpen;

    private void TogglePanel() => isPanelOpen = !isPanelOpen;
    private void ClosePanel() => isPanelOpen = false;
    private void NavigateToChangePassword()
    {
        isPanelOpen = false;
        NavigationManager.NavigateTo("ChangePassword");
    }
    private void NavigateToLogout()
    {
        isPanelOpen = false;
        NavigationManager.NavigateTo("Logout");
    }

    private static string BuildFullName(string? given, string? family, string? nameClaim)
    {
        var cleanedGiven = string.IsNullOrWhiteSpace(given) ? null : ToTitleCaseSafe(given);
        var cleanedFamily = string.IsNullOrWhiteSpace(family) ? null : ToTitleCaseSafe(family);

        if (!string.IsNullOrWhiteSpace(cleanedGiven) || !string.IsNullOrWhiteSpace(cleanedFamily))
            return string.Join(" ", new[] { cleanedGiven, cleanedFamily }.Where(s => !string.IsNullOrWhiteSpace(s)));

        return string.IsNullOrWhiteSpace(nameClaim) ? string.Empty : ToTitleCaseSafe(nameClaim);
    }

    private static string ToTitleCaseSafe(string input)
    {
        var s = input.Trim();
        try
        {
            var lower = s.ToLower(CultureInfo.CurrentCulture);
            return CultureInfo.CurrentCulture.TextInfo.ToTitleCase(lower);
        }
        catch
        {
            return s;
        }
    }

    private static string FormatStringType(string raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return string.Empty;
        var s = raw.Trim();
        if ((s.StartsWith("\"") && s.EndsWith("\"")) || (s.StartsWith("'") && s.EndsWith("'")))
            s = s.Substring(1, s.Length - 2).Trim();
        var trimmed = s.Trim();
        if (trimmed.StartsWith("[") && trimmed.EndsWith("]"))
        {
            try
            {
                var arr = JsonSerializer.Deserialize<string[]>(trimmed);
                if (arr != null && arr.Length > 0)
                    return string.Join(", ", arr.Select(x => x?.Trim('"', '\'').Trim()));
            }
            catch
            {
                s = trimmed.Trim('[', ']', ' ', '"', '\'');
            }
        }
        return s;
    }
}